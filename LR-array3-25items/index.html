<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listener Responding ‚Äî Array of 3 (25 Items)</title>
  <style>
    :root { --gap: 12px; --radius: 14px; --border: 1px solid rgba(0,0,0,.12); }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f7f7f9; color: #111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border: var(--border); border-radius: var(--radius); padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1 1 auto; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .sub { font-size: 13px; color: rgba(0,0,0,.65); }

    .sd { font-size: clamp(18px, 3vw, 26px); font-weight: 950; margin: 10px 0 2px; }
    .sdmeta { font-size: 12px; color: rgba(0,0,0,.6); }

    .grid { display: grid; gap: var(--gap); grid-template-columns: repeat(3, minmax(0, 1fr)); margin-top: 12px; }
    @media (max-width: 520px) { .grid { grid-template-columns: 1fr; } }

    .tile{
      user-select: none;
      border: var(--border);
      border-radius: 16px;
      padding: 12px;
      background: #fff;
      display: grid;
      place-items: center;
      min-height: 180px;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .06s ease;
      text-align: center;
      position: relative;
    }
    .tile:active { transform: scale(.99); }
    .tile:hover { box-shadow: 0 3px 10px rgba(0,0,0,.06); }
    .tile[aria-disabled="true"] { opacity: .35; cursor: not-allowed; box-shadow: none; }

    .pic { width: 100%; display: grid; place-items: center; }
    .pic img { width: 100%; max-width: 160px; height: 160px; object-fit: contain; }
    .lbl { margin-top: 8px; font-weight: 850; font-size: 14px; }

    .controls { display: grid; gap: 10px; grid-template-columns: repeat(3, minmax(0, 1fr)); margin-top: 8px; }
    @media (max-width: 820px) { .controls { grid-template-columns: 1fr; } }
    .btn{
      border: var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 850;
    }
    .btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,.05); }

    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      border: var(--border); border-radius:999px; padding:8px 10px; background:#fff;
      gap:8px; font-weight:850;
    }
    .kpi { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .kpi .pill { background: #fbfbfd; }

    .feedback { margin-top: 10px; padding: 10px 12px; border-radius: 12px; border: var(--border); background: #fafafa; }
    .fb-neutral { color: rgba(0,0,0,.82); }
    .fb-good { font-weight: 950; }
    .mini { font-size: 12px; color: rgba(0,0,0,.65); }
    .danger { color: #b00020; }
    .good { color: #0a7a1f; }

    details { border: var(--border); border-radius: var(--radius); padding: 10px 12px; background: #fff; }
    summary { cursor: pointer; font-weight: 900; }
    code { background: #f1f1f4; padding: 2px 6px; border-radius: 8px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>Listener Responding ‚Äî Array of 3 (25 Items)</h1>
          <div class="sub">25 targets ‚Ä¢ randomized order ‚Ä¢ error correction + recycling ‚Ä¢ shared image library</div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <span class="pill">Spoken SD: <span id="ttsLabel">On</span></span>
        </div>
      </div>

      <div class="sd" id="sdText">Loading‚Ä¶</div>
      <div class="sdmeta" id="sdMeta"></div>

      <div class="controls">
        <button class="btn" id="speakBtn" type="button">üîä Play SD</button>
        <button class="btn" id="nextBtn" type="button" disabled>Next Trial</button>
        <button class="btn" id="restartBtn" type="button">Restart Session</button>
      </div>

      <div class="kpi">
        <span class="pill">Trial <span id="trialNum">1</span>/<span id="trialTotal">25</span></span>
        <span class="pill">Correct <span id="kpiCorrect">0</span></span>
        <span class="pill">Incorrect <span id="kpiIncorrect">0</span></span>
        <span class="pill">Recycled <span id="kpiRecycled">0</span></span>
      </div>

      <div id="grid" class="grid" aria-label="Answer choices"></div>

      <div class="feedback">
        <div id="feedbackText" class="fb-neutral">Select an answer.</div>
        <div id="promptText" class="mini" style="margin-top:6px;"></div>
      </div>
    </div>

    <div style="height: 12px;"></div>

    <details>
      <summary>‚öôÔ∏è Therapist Panel</summary>

      <div class="row" style="margin-top:10px;">
        <label style="display:flex; align-items:center; gap:10px;">
          <input id="ttsToggle" type="checkbox" checked />
          <span><strong>Spoken SD playback</strong> <span class="mini">(device text-to-speech)</span></span>
        </label>

        <label style="display:flex; align-items:center; gap:10px;">
          <input id="indirectPromptToggle" type="checkbox" checked />
          <span><strong>Indirect prompt on errors</strong> <span class="mini">(text + optional audio)</span></span>
        </label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="runMissedBtn" type="button">Run Recycled-Only Block</button>
        <button class="btn" id="resumeMixedBtn" type="button">Resume Mixed Block</button>
        <button class="btn" id="resetDataBtn" type="button">Reset Data Only</button>
      </div>

      <div class="mini" style="margin-top:10px;">
        Images expected at <code>../images/food</code>, <code>../images/drinks</code>, <code>../images/other</code>.
      </div>
    </details>
  </div>

<script>
/**
 * 25 TARGET ITEMS ‚Äî update filenames here only if yours differ.
 * These are pulled from your shared library.
 */
const TARGETS_25 = [
  // 10 food
  { id:"apple", label:"Apple", img:"../images/food/food_apple.jpg" },
  { id:"banana", label:"Banana", img:"../images/food/food_banana.jpg" },
  { id:"orange", label:"Orange", img:"../images/food/food_orange.jpg" },
  { id:"grapes", label:"Grapes", img:"../images/food/food_grapes.jpg" },
  { id:"strawberries", label:"Strawberries", img:"../images/food/food_strawberries.jpg" },
  { id:"sandwich", label:"Sandwich", img:"../images/food/food_sandwich.jpg" },
  { id:"pizza_slice", label:"Pizza", img:"../images/food/food_pizza_slice.jpg" },
  { id:"cookie", label:"Cookie", img:"../images/food/food_cookie.jpg" },
  { id:"chips_bag", label:"Chips", img:"../images/food/food_chips_bag.jpg" },
  { id:"ice_cream_scoop", label:"Ice Cream", img:"../images/food/food_ice_cream_scoop.jpg" },

  // 5 drinks
  { id:"water_bottle", label:"Water Bottle", img:"../images/drinks/drink_water_bottle.jpg" },
  { id:"milk_glass", label:"Milk", img:"../images/drinks/drink_milk_glass.jpg" },
  { id:"juice_box", label:"Juice Box", img:"../images/drinks/drink_juice_box.jpg" },
  { id:"soda_can", label:"Soda", img:"../images/drinks/drink_soda_can.jpg" },
  { id:"sports_drink", label:"Sports Drink", img:"../images/drinks/drink_sports_drink.jpg" },

  // 10 other
  { id:"ball", label:"Ball", img:"../images/other/other_ball.jpg" },
  { id:"book", label:"Book", img:"../images/other/other_book.jpg" },
  { id:"pencil", label:"Pencil", img:"../images/other/other_pencil.jpg" },
  { id:"crayons", label:"Crayons", img:"../images/other/other_crayons.jpg" },
  { id:"notebook", label:"Notebook", img:"../images/other/other_notebook.jpg" },
  { id:"backpack", label:"Backpack", img:"../images/other/other_backpack.jpg" },
  { id:"shoe", label:"Shoe", img:"../images/other/other_shoe.jpg" },
  { id:"hat", label:"Hat", img:"../images/other/other_hat.jpg" },
  { id:"toothbrush", label:"Toothbrush", img:"../images/other/other_toothbrush.jpg" },
  { id:"remote", label:"Remote", img:"../images/other/other_remote.jpg" },
];

// CONFIG
const CONFIG = {
  fieldSize: 3,
  recycleDelayMin: 2,
  recycleDelayMax: 6,
};

// ============================
// State
// ============================
let state = {
  ttsEnabled: true,
  indirectPromptEnabled: true,
  recycleOnly: false,

  queue: [],
  recycled: [],
  current: null,

  trialIndex: 0,
  correct: 0,
  incorrect: 0,
  recycledCount: 0,

  disabledIds: new Set(),
  locked: false,
  firstAttemptWrong: false,
};

// ============================
// Helpers
// ============================
function shuffle(arr){
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function pickRandom(arr, n){ return shuffle(arr).slice(0, n); }

function speak(text){
  if (!state.ttsEnabled) return;
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
  window.speechSynthesis.speak(u);
}
function setFeedback(text, kind="neutral"){
  const el = document.getElementById("feedbackText");
  el.textContent = text;
  if (kind === "good") el.className = "fb-good good";
  else if (kind === "bad") el.className = "fb-neutral danger";
  else el.className = "fb-neutral";
}
function setPrompt(text){ document.getElementById("promptText").textContent = text || ""; }

function updateHeader(){
  document.getElementById("ttsLabel").textContent = state.ttsEnabled ? "On" : "Off";
}
function updateKPI(){
  document.getElementById("trialNum").textContent = String(Math.min(state.trialIndex + 1, 999));
  document.getElementById("trialTotal").textContent = String(25);
  document.getElementById("kpiCorrect").textContent = String(state.correct);
  document.getElementById("kpiIncorrect").textContent = String(state.incorrect);
  document.getElementById("kpiRecycled").textContent = String(state.recycledCount);
}

function indirectPromptText(){
  return "Try again. Listen carefully to the word.";
}

function buildQueue(){
  // One trial per target (25 trials), randomized
  state.queue = shuffle(TARGETS_25.map(t => ({
    id: `lr3-${t.id}-${Math.random().toString(16).slice(2)}`,
    target: t,
    choices: [],
    firstAttemptWrong: false,
  })));
  state.recycled = [];
  state.recycledCount = 0;
  state.trialIndex = 0;
}

function makeChoicesForTarget(target){
  const distractorPool = TARGETS_25.filter(x => x.id !== target.id);
  const distractors = pickRandom(distractorPool, CONFIG.fieldSize - 1);
  return shuffle([target, ...distractors]);
}

function renderTrial(){
  state.disabledIds = new Set();
  state.locked = false;
  state.firstAttemptWrong = false;

  // Build array-of-3 for this target
  state.current.choices = makeChoicesForTarget(state.current.target);

  document.getElementById("sdText").textContent = `Touch the ${state.current.target.label}.`;
  document.getElementById("sdMeta").textContent = "Array size: 3 ‚Ä¢ 25 target items ‚Ä¢ randomized order";
  document.getElementById("nextBtn").disabled = true;

  setFeedback("Select an answer.", "neutral");
  setPrompt("");

  updateHeader();
  updateKPI();
  renderChoices();
}

function renderChoices(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  state.current.choices.forEach(item => {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.setAttribute("role", "button");
    tile.setAttribute("tabindex", "0");

    const disabled = state.disabledIds.has(item.id) || state.locked;
    tile.setAttribute("aria-disabled", disabled ? "true" : "false");

    const pic = document.createElement("div");
    pic.className = "pic";

    const img = document.createElement("img");
    img.src = item.img;
    img.alt = item.label;
    img.loading = "lazy";
    img.onerror = () => {
      img.style.display = "none";
      const msg = document.createElement("div");
      msg.className = "mini danger";
      msg.textContent = "Image not found";
      pic.appendChild(msg);
    };
    pic.appendChild(img);

    const lbl = document.createElement("div");
    lbl.className = "lbl";
    lbl.textContent = item.label;

    tile.appendChild(pic);
    tile.appendChild(lbl);

    const activate = () => {
      if (tile.getAttribute("aria-disabled") === "true") return;
      onSelect(item.id);
    };
    tile.addEventListener("click", activate);
    tile.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); activate(); }
    });

    grid.appendChild(tile);
  });
}

function injectRecycledLater(trial){
  const delay = CONFIG.recycleDelayMin + Math.floor(Math.random() * (CONFIG.recycleDelayMax - CONFIG.recycleDelayMin + 1));
  const idx = Math.min(delay, state.queue.length);
  state.queue.splice(idx, 0, JSON.parse(JSON.stringify(trial)));
  state.recycledCount += 1;
  updateKPI();
}

function pullNextTrial(){
  if (state.recycleOnly) {
    if (state.recycled.length === 0) return null;
    return state.recycled.shift();
  }
  if (state.queue.length === 0) {
    if (state.recycled.length > 0) return state.recycled.shift();
    return null;
  }
  return state.queue.shift();
}

function next(){
  const nxt = pullNextTrial();
  if (!nxt) {
    document.getElementById("grid").innerHTML = "";
    document.getElementById("sdText").textContent = "Block complete.";
    document.getElementById("sdMeta").textContent = "";
    document.getElementById("nextBtn").disabled = true;
    setFeedback("Nice job finishing the block!", "good");
    setPrompt("");
    return;
  }
  state.current = nxt;
  renderTrial();
}

function onIncorrect(choiceId){
  state.incorrect += 1;
  state.firstAttemptWrong = true;
  state.current.firstAttemptWrong = true;

  setFeedback("Try again.", "bad");

  if (state.indirectPromptEnabled) {
    const p = indirectPromptText();
    setPrompt(p);
    speak(p);
  }

  // Grey out incorrect option
  state.disabledIds.add(choiceId);
  renderChoices();
  updateKPI();
}

function onCorrect(){
  state.correct += 1;
  state.locked = true;
  renderChoices();

  setFeedback("Nice job!", "good");
  setPrompt("");
  document.getElementById("nextBtn").disabled = false;
  updateKPI();

  // Recycle missed trial later
  if (state.current.firstAttemptWrong && !state.recycleOnly) {
    injectRecycledLater(state.current);
  }
}

function onSelect(choiceId){
  if (!state.current) return;
  if (choiceId === state.current.target.id) onCorrect();
  else onIncorrect(choiceId);
}

// ============================
// UI bindings
// ============================
document.getElementById("speakBtn").addEventListener("click", () => {
  if (!state.current) return;
  speak(`Touch the ${state.current.target.label}.`);
});
document.getElementById("nextBtn").addEventListener("click", () => {
  state.trialIndex += 1;
  next();
});
document.getElementById("restartBtn").addEventListener("click", () => startSession());

document.getElementById("ttsToggle").addEventListener("change", (e) => {
  state.ttsEnabled = !!e.target.checked;
  updateHeader();
});
document.getElementById("indirectPromptToggle").addEventListener("change", (e) => {
  state.indirectPromptEnabled = !!e.target.checked;
});
document.getElementById("runMissedBtn").addEventListener("click", () => {
  state.recycleOnly = true;
  setFeedback("Recycled-only block started.", "neutral");
  next();
});
document.getElementById("resumeMixedBtn").addEventListener("click", () => {
  state.recycleOnly = false;
  setFeedback("Mixed block resumed.", "neutral");
  next();
});
document.getElementById("resetDataBtn").addEventListener("click", () => {
  state.correct = 0;
  state.incorrect = 0;
  state.recycledCount = 0;
  state.trialIndex = 0;
  updateKPI();
  setFeedback("Data reset.", "neutral");
});

// ============================
// Session start
// ============================
function startSession(){
  window.speechSynthesis?.cancel?.();

  state.correct = 0;
  state.incorrect = 0;
  state.recycledCount = 0;
  state.trialIndex = 0;
  state.recycleOnly = false;

  buildQueue();
  updateHeader();
  updateKPI();
  next();
}

startSession();
</script>
</body>
</html>
