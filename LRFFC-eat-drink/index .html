<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LRFFC Level 1 ‚Äî Eat vs Drink (Field of 5)</title>
  <style>
    :root { --gap: 12px; --radius: 14px; --border: 1px solid rgba(0,0,0,.12); }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f7f7f9; color: #111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border: var(--border); border-radius: var(--radius); padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1 1 auto; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .sd { font-size: clamp(18px, 3vw, 26px); font-weight: 700; margin: 10px 0; }
    .sub { font-size: 13px; color: rgba(0,0,0,.65); }
    .grid { display: grid; gap: var(--gap); grid-template-columns: repeat(5, minmax(0, 1fr)); margin-top: 12px; }
    @media (max-width: 820px) { .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 520px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .tile {
      user-select: none;
      border: var(--border);
      border-radius: 16px;
      padding: 12px;
      background: #fff;
      display: grid;
      place-items: center;
      min-height: 120px;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .06s ease;
      text-align: center;
      position: relative;
    }
    .tile:active { transform: scale(.99); }
    .tile:hover { box-shadow: 0 3px 10px rgba(0,0,0,.06); }
    .tile[aria-disabled="true"] { opacity: .35; cursor: not-allowed; box-shadow: none; }
    .pic { font-size: clamp(42px, 6vw, 60px); line-height: 1; }
    .lbl { margin-top: 8px; font-weight: 600; font-size: 14px; }
    .feedback { margin-top: 10px; padding: 10px 12px; border-radius: 12px; border: var(--border); background: #fafafa; }
    .fb-neutral { color: rgba(0,0,0,.8); }
    .fb-good { font-weight: 800; }
    .controls { display: grid; gap: 10px; grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 820px) { .controls { grid-template-columns: 1fr; } }
    .btn {
      border: var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 650;
    }
    .btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    .toggle { display: flex; align-items: center; gap: 10px; }
    .pill {
      display: inline-flex; align-items: center; justify-content: center;
      border: var(--border); border-radius: 999px; padding: 8px 10px; background: #fff;
      gap: 8px; font-weight: 650;
    }
    .mini { font-size: 12px; color: rgba(0,0,0,.65); }
    details { border: var(--border); border-radius: var(--radius); padding: 10px 12px; background: #fff; }
    summary { cursor: pointer; font-weight: 750; }
    .kpi { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .kpi .pill { background: #fbfbfd; }
    .danger { color: #b00020; }
    .good { color: #0a7a1f; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>LRFFC Level 1 ‚Äî Eat vs Drink (Field of 5)</h1>
          <div class="sub">VB-MAPP‚Äìaligned SDs + error correction + trial recycling. Responsive for phones ‚Üí laptops.</div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <span class="pill">Mode: <span id="modeLabel">Eat</span></span>
          <span class="pill">Spoken SD: <span id="ttsLabel">On</span></span>
        </div>
      </div>

      <div class="sd" id="sdText">Which do you eat?</div>

      <div class="controls">
        <button class="btn" id="speakBtn" type="button">üîä Play SD</button>
        <button class="btn" id="nextBtn" type="button" disabled>Next Trial</button>
        <button class="btn" id="restartBtn" type="button">Restart Session</button>
      </div>

      <div class="kpi">
        <span class="pill">Trial <span id="trialNum">1</span>/<span id="trialTotal">0</span></span>
        <span class="pill">Correct <span id="kpiCorrect">0</span></span>
        <span class="pill">Incorrect <span id="kpiIncorrect">0</span></span>
        <span class="pill">Recycled <span id="kpiRecycled">0</span></span>
      </div>

      <div id="grid" class="grid" aria-label="Answer choices"></div>

      <div class="feedback" id="feedbackBox">
        <div id="feedbackText" class="fb-neutral">Select an answer.</div>
        <div id="promptText" class="mini" style="margin-top:6px;"></div>
      </div>
    </div>

    <div style="height: 12px;"></div>

    <details>
      <summary>‚öôÔ∏è Therapist Panel</summary>
      <div class="row" style="margin-top:10px;">
        <label class="toggle">
          <input id="modeToggle" type="checkbox" />
          <span><strong>Drink mode</strong> <span class="mini">(unchecked = Eat mode)</span></span>
        </label>

        <label class="toggle">
          <input id="ttsToggle" type="checkbox" checked />
          <span><strong>Spoken SD playback</strong> <span class="mini">(uses device text-to-speech)</span></span>
        </label>

        <label class="toggle">
          <input id="indirectPromptToggle" type="checkbox" checked />
          <span><strong>Indirect prompt on errors</strong> <span class="mini">(text + optional audio)</span></span>
        </label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="runMissedBtn" type="button">Run Recycled-Only Block</button>
        <button class="btn" id="resumeMixedBtn" type="button">Resume Mixed Block</button>
        <button class="btn" id="resetDataBtn" type="button">Reset Data Only</button>
      </div>

      <div class="mini" style="margin-top:10px;">
        <strong>Note:</strong> This prototype uses emoji as ‚Äúpictures‚Äù by default. You can replace them with your own image URLs in the <code>ITEM_BANK</code> section.
      </div>
    </details>
  </div>

<script>
/**
 * ============================
 *  EDITABLE ITEM BANK
 * ============================
 * Replace emoji with image URLs if you want real pictures:
 * { id:"apple", label:"Apple", img:"https://.../apple.png", type:"food" }
 */
const ITEM_BANK = [
  { id:"apple",   label:"Apple",   emoji:"üçé", type:"food" },
  { id:"banana",  label:"Banana",  emoji:"üçå", type:"food" },
  { id:"pizza",   label:"Pizza",   emoji:"üçï", type:"food" },
  { id:"cookie",  label:"Cookie",  emoji:"üç™", type:"food" },
  { id:"sandwich",label:"Sandwich",emoji:"ü•™", type:"food" },
  { id:"milk",    label:"Milk",    emoji:"ü•õ", type:"drink" },
  { id:"water",   label:"Water",   emoji:"üíß", type:"drink" },
  { id:"juice",   label:"Juice",   emoji:"üßÉ", type:"drink" },
  { id:"soda",    label:"Soda",    emoji:"ü•§", type:"drink" },
  { id:"coffee",  label:"Coffee",  emoji:"‚òï", type:"drink" },

  // distractors (not eat/drink)
  { id:"ball",    label:"Ball",    emoji:"‚öΩ", type:"other" },
  { id:"car",     label:"Car",     emoji:"üöó", type:"other" },
  { id:"book",    label:"Book",    emoji:"üìö", type:"other" },
  { id:"shirt",   label:"Shirt",   emoji:"üëï", type:"other" },
  { id:"shoe",    label:"Shoe",    emoji:"üëü", type:"other" },
];

const CONFIG = {
  fieldSize: 5,
  trialsPerBlock: 12,        // adjust for session length
  recycleDelayMin: 2,        // min trials before reinsert
  recycleDelayMax: 5,        // max trials before reinsert
};

// ============================
// State
// ============================
let state = {
  mode: "eat",               // "eat" or "drink"
  ttsEnabled: true,
  indirectPromptEnabled: true,
  recycleOnly: false,

  queue: [],
  recycled: [],
  current: null,

  trialIndex: 0,
  correct: 0,
  incorrect: 0,
  recycledCount: 0,

  errorStep: 0,              // 0 = none, 1 = after first error (indirect prompt), 2+ = grey-out progression
  disabledIds: new Set(),
  locked: false,
};

// ============================
// Helpers
// ============================
function shuffle(arr){
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function pickRandom(arr, n){
  return shuffle(arr).slice(0, n);
}

function byType(type){
  return ITEM_BANK.filter(x => x.type === type);
}

function speak(text){
  if (!state.ttsEnabled) return;
  if (!("speechSynthesis" in window)) return;

  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.0;
  u.pitch = 1.0;
  u.volume = 1.0;
  window.speechSynthesis.speak(u);
}

function setFeedback(text, kind="neutral"){
  const el = document.getElementById("feedbackText");
  el.textContent = text;
  el.className = kind === "good" ? "fb-good good" : (kind === "bad" ? "fb-neutral danger" : "fb-neutral");
}

function setPrompt(text){
  document.getElementById("promptText").textContent = text || "";
}

function updateHeader(){
  document.getElementById("modeLabel").textContent = state.mode === "eat" ? "Eat" : "Drink";
  document.getElementById("ttsLabel").textContent = state.ttsEnabled ? "On" : "Off";
  document.getElementById("sdText").textContent = state.mode === "eat" ? "Which do you eat?" : "Which do you drink?";
}

function updateKPI(){
  document.getElementById("trialNum").textContent = String(Math.min(state.trialIndex + 1, totalTrials()));
  document.getElementById("trialTotal").textContent = String(totalTrials());
  document.getElementById("kpiCorrect").textContent = String(state.correct);
  document.getElementById("kpiIncorrect").textContent = String(state.incorrect);
  document.getElementById("kpiRecycled").textContent = String(state.recycledCount);
}

function totalTrials(){
  // not ‚Äúinfinite accurate‚Äù because we recycle, but good enough for display
  return Math.max(state.queue.length + (state.current ? 1 : 0) + state.recycled.length, 1);
}

function makeTrial(){
  const targetType = state.mode === "eat" ? "food" : "drink";
  const target = pickRandom(byType(targetType), 1)[0];

  // distractors: include a mix of other types to strengthen discrimination
  const distractorPool = ITEM_BANK.filter(x => x.id !== target.id);
  const distractors = pickRandom(distractorPool, CONFIG.fieldSize - 1);

  const choices = shuffle([target, ...distractors]);
  return {
    id: `${state.mode}-${target.id}-${Math.random().toString(16).slice(2)}`,
    mode: state.mode,
    targetId: target.id,
    choices,
    targetType,
    firstAttemptWrong: false,
  };
}

function buildQueue(){
  const block = [];
  for (let i = 0; i < CONFIG.trialsPerBlock; i++) block.push(makeTrial());
  state.queue = block;
  state.recycled = [];
  state.recycledCount = 0;
  state.trialIndex = 0;
}

function renderChoices(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  state.current.choices.forEach(item => {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.setAttribute("role", "button");
    tile.setAttribute("tabindex", "0");

    const disabled = state.disabledIds.has(item.id) || state.locked;
    tile.setAttribute("aria-disabled", disabled ? "true" : "false");

    const pic = document.createElement("div");
    pic.className = "pic";

    // emoji default; if you add item.img, it will display an image
    if (item.img) {
      const img = document.createElement("img");
      img.src = item.img;
      img.alt = item.label;
      img.style.maxWidth = "80px";
      img.style.maxHeight = "80px";
      img.style.objectFit = "contain";
      pic.appendChild(img);
    } else {
      pic.textContent = item.emoji || "‚ùì";
    }

    const lbl = document.createElement("div");
    lbl.className = "lbl";
    lbl.textContent = item.label;

    tile.appendChild(pic);
    tile.appendChild(lbl);

    const activate = () => {
      if (tile.getAttribute("aria-disabled") === "true") return;
      onSelect(item.id);
    };

    tile.addEventListener("click", activate);
    tile.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); activate(); }
    });

    grid.appendChild(tile);
  });
}

function enableNext(enabled){
  const btn = document.getElementById("nextBtn");
  btn.disabled = !enabled;
}

function startTrial(){
  state.errorStep = 0;
  state.disabledIds = new Set();
  state.locked = false;
  enableNext(false);
  setFeedback("Select an answer.", "neutral");
  setPrompt("");

  updateHeader();
  updateKPI();
  renderChoices();

  // auto-speak SD (optional; currently we leave manual via button)
}

function pullNextTrial(){
  // If recycle-only mode, draw from recycled list; else mixed queue w/ recycled injected later.
  if (state.recycleOnly) {
    if (state.recycled.length === 0) return null;
    return state.recycled.shift();
  }

  if (state.queue.length === 0) {
    // If queue empty but recycled exists, continue
    if (state.recycled.length > 0) return state.recycled.shift();
    return null;
  }
  return state.queue.shift();
}

function injectRecycledLater(trial){
  const delay = CONFIG.recycleDelayMin + Math.floor(Math.random() * (CONFIG.recycleDelayMax - CONFIG.recycleDelayMin + 1));
  const idx = Math.min(delay, state.queue.length);
  state.queue.splice(idx, 0, trial);
  state.recycledCount += 1;
  updateKPI();
}

function next(){
  const nxt = pullNextTrial();
  if (!nxt) {
    state.current = null;
    document.getElementById("grid").innerHTML = "";
    enableNext(false);
    setFeedback("Block complete.", "good");
    setPrompt("");
    return;
  }
  state.current = nxt;
  startTrial();
}

function indirectPromptText(){
  if (state.mode === "eat") return "Remember: you eat food. Food goes in your mouth.";
  return "Remember: you drink drinks. Drinks go in a cup and you sip them.";
}

function onIncorrect(choiceId){
  state.incorrect += 1;
  state.current.firstAttemptWrong = true;

  // Step 1: neutral feedback + (optional) indirect prompt
  if (state.errorStep === 0) {
    setFeedback("Try again.", "bad");
    if (state.indirectPromptEnabled) {
      const p = indirectPromptText();
      setPrompt(p);
      // Optional audio prompt (still indirect)
      speak(p);
    } else {
      setPrompt("");
    }
    state.errorStep = 1;
    updateKPI();
    return;
  }

  // Step 2+: grey-out one incorrect option at a time
  // Grey out the most recently selected wrong choice first (and then continue)
  state.disabledIds.add(choiceId);
  setFeedback("Try again.", "bad");

  // If still not correct, we can also grey out another wrong one to ensure progress:
  // (Only if user keeps picking disabled? they can‚Äôt.)
  renderChoices();
  state.errorStep += 1;
  updateKPI();
}

function onCorrect(){
  state.correct += 1;
  state.locked = true;
  renderChoices();

  // enthusiastic feedback (but not over-the-top)
  setFeedback("Nice job!", "good");
  setPrompt("");

  // Speak praise lightly (optional; currently not speaking praise to keep it mature)
  // speak("Nice job!");

  enableNext(true);
  updateKPI();

  // If trial had an error on first attempt, recycle it later
  if (state.current.firstAttemptWrong && !state.recycleOnly) {
    const clone = JSON.parse(JSON.stringify(state.current));
    clone.firstAttemptWrong = false; // fresh attempt later
    injectRecycledLater(clone);
  }
}

function onSelect(choiceId){
  if (!state.current) return;
  const correctId = state.current.targetId;

  if (choiceId === correctId) {
    onCorrect();
  } else {
    onIncorrect(choiceId);
  }
}

// ============================
// UI bindings
// ============================
document.getElementById("speakBtn").addEventListener("click", () => {
  speak(state.mode === "eat" ? "Which do you eat?" : "Which do you drink?");
});

document.getElementById("nextBtn").addEventListener("click", () => {
  state.trialIndex += 1;
  next();
});

document.getElementById("restartBtn").addEventListener("click", () => {
  startSession();
});

document.getElementById("modeToggle").addEventListener("change", (e) => {
  state.mode = e.target.checked ? "drink" : "eat";
  // rebuild a fresh block when mode changes
  startSession(false);
});

document.getElementById("ttsToggle").addEventListener("change", (e) => {
  state.ttsEnabled = !!e.target.checked;
  updateHeader();
});

document.getElementById("indirectPromptToggle").addEventListener("change", (e) => {
  state.indirectPromptEnabled = !!e.target.checked;
});

document.getElementById("runMissedBtn").addEventListener("click", () => {
  state.recycleOnly = true;
  setFeedback("Recycled-only block started.", "neutral");
  next();
});

document.getElementById("resumeMixedBtn").addEventListener("click", () => {
  state.recycleOnly = false;
  setFeedback("Mixed block resumed.", "neutral");
  next();
});

document.getElementById("resetDataBtn").addEventListener("click", () => {
  state.correct = 0;
  state.incorrect = 0;
  state.recycledCount = 0;
  updateKPI();
  setFeedback("Data reset.", "neutral");
});

function startSession(keepMode = true){
  window.speechSynthesis?.cancel?.();

  if (!keepMode) {
    // mode already set by toggle; do nothing
  }

  state.correct = 0;
  state.incorrect = 0;
  state.recycledCount = 0;
  state.trialIndex = 0;
  state.recycleOnly = false;

  buildQueue();
  updateHeader();
  updateKPI();
  next();
}

// Start
startSession(true);
</script>
</body>
</html>


