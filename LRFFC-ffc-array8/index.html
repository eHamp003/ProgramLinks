<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LRFFC Level 2 ‚Äî FFC (Array of 8)</title>
  <style>
    :root { --gap: 12px; --radius: 14px; --border: 1px solid rgba(0,0,0,.12); }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f7f7f9; color: #111; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border: var(--border); border-radius: var(--radius); padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1 1 auto; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .sub { font-size: 13px; color: rgba(0,0,0,.65); }

    .sd { font-size: clamp(18px, 3vw, 26px); font-weight: 900; margin: 10px 0 4px; }
    .sdmeta { font-size: 12px; color: rgba(0,0,0,.6); }

    .grid { display: grid; gap: var(--gap); grid-template-columns: repeat(8, minmax(0, 1fr)); margin-top: 12px; }
    @media (max-width: 980px) { .grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    @media (max-width: 520px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .tile{
      user-select: none;
      border: var(--border);
      border-radius: 16px;
      padding: 10px;
      background: #fff;
      display: grid;
      place-items: center;
      min-height: 140px;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .06s ease;
      text-align: center;
      position: relative;
    }
    .tile:active { transform: scale(.99); }
    .tile:hover { box-shadow: 0 3px 10px rgba(0,0,0,.06); }
    .tile[aria-disabled="true"] { opacity: .35; cursor: not-allowed; box-shadow: none; }

    .pic { width: 100%; display: grid; place-items: center; }
    .pic img { width: 100%; max-width: 120px; height: 120px; object-fit: contain; }
    .lbl { margin-top: 8px; font-weight: 750; font-size: 13px; }

    .controls { display: grid; gap: 10px; grid-template-columns: repeat(3, minmax(0, 1fr)); margin-top: 8px; }
    @media (max-width: 820px) { .controls { grid-template-columns: 1fr; } }
    .btn{
      border: var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 750;
    }
    .btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      border: var(--border); border-radius:999px; padding:8px 10px; background:#fff;
      gap:8px; font-weight:750;
    }
    .kpi { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .kpi .pill { background: #fbfbfd; }

    .feedback { margin-top: 10px; padding: 10px 12px; border-radius: 12px; border: var(--border); background: #fafafa; }
    .fb-neutral { color: rgba(0,0,0,.82); }
    .fb-good { font-weight: 950; }
    .mini { font-size: 12px; color: rgba(0,0,0,.65); }
    .danger { color: #b00020; }
    .good { color: #0a7a1f; }
    details { border: var(--border); border-radius: var(--radius); padding: 10px 12px; background: #fff; }
    summary { cursor: pointer; font-weight: 900; }
    code { background: #f1f1f4; padding: 2px 6px; border-radius: 8px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>LRFFC Level 2 ‚Äî Function / Feature / Class (Array of 8)</h1>
          <div class="sub">25 targets ‚Ä¢ clue-by-clue prompting ‚Ä¢ error correction + trial recycling ‚Ä¢ shared image library</div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <span class="pill">Clue <span id="clueNum">1</span>/<span id="clueTotal">2</span></span>
          <span class="pill">Spoken SD: <span id="ttsLabel">On</span></span>
        </div>
      </div>

      <div class="sd" id="sdText">Loading‚Ä¶</div>
      <div class="sdmeta" id="sdMeta"></div>

      <div class="controls">
        <button class="btn" id="speakBtn" type="button">üîä Play SD</button>
        <button class="btn" id="nextBtn" type="button" disabled>Next Trial</button>
        <button class="btn" id="restartBtn" type="button">Restart Session</button>
      </div>

      <div class="kpi">
        <span class="pill">Trial <span id="trialNum">1</span>/<span id="trialTotal">25</span></span>
        <span class="pill">Correct <span id="kpiCorrect">0</span></span>
        <span class="pill">Incorrect <span id="kpiIncorrect">0</span></span>
        <span class="pill">Recycled <span id="kpiRecycled">0</span></span>
      </div>

      <div id="grid" class="grid" aria-label="Answer choices"></div>

      <div class="feedback">
        <div id="feedbackText" class="fb-neutral">Select an answer.</div>
        <div id="promptText" class="mini" style="margin-top:6px;"></div>
      </div>
    </div>

    <div style="height: 12px;"></div>

    <details>
      <summary>‚öôÔ∏è Therapist Panel</summary>

      <div class="row" style="margin-top:10px;">
        <label style="display:flex; align-items:center; gap:10px;">
          <input id="ttsToggle" type="checkbox" checked />
          <span><strong>Spoken SD playback</strong> <span class="mini">(uses device text-to-speech)</span></span>
        </label>

        <label style="display:flex; align-items:center; gap:10px;">
          <input id="indirectPromptToggle" type="checkbox" checked />
          <span><strong>Indirect prompt on errors</strong> <span class="mini">(text + optional audio)</span></span>
        </label>

        <label style="display:flex; align-items:center; gap:10px;">
          <input id="autoAdvanceClueToggle" type="checkbox" checked />
          <span><strong>Auto-advance to next clue</strong> <span class="mini">(after first error)</span></span>
        </label>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="runMissedBtn" type="button">Run Recycled-Only Block</button>
        <button class="btn" id="resumeMixedBtn" type="button">Resume Mixed Block</button>
        <button class="btn" id="resetDataBtn" type="button">Reset Data Only</button>
      </div>

      <div class="mini" style="margin-top:10px;">
        Images expected at <code>../images/food</code>, <code>../images/drinks</code>, <code>../images/other</code>.
      </div>
    </details>
  </div>

<script>
const ITEM_BANK = [
  { id:"apple", label:"Apple", img:"../images/food/food_apple.jpg", type:"food" },
  { id:"banana", label:"Banana", img:"../images/food/food_banana.jpg", type:"food" },
  { id:"pizza_slice", label:"Pizza", img:"../images/food/food_pizza_slice.jpg", type:"food" },
  { id:"sandwich", label:"Sandwich", img:"../images/food/food_sandwich.jpg", type:"food" },
  { id:"cookie", label:"Cookie", img:"../images/food/food_cookie.jpg", type:"food" },
  { id:"water_bottle", label:"Water Bottle", img:"../images/drinks/drink_water_bottle.jpg", type:"drink" },
  { id:"milk_glass", label:"Milk", img:"../images/drinks/drink_milk_glass.jpg", type:"drink" },
  { id:"juice_box", label:"Juice Box", img:"../images/drinks/drink_juice_box.jpg", type:"drink" },
  { id:"soda_can", label:"Soda (Can)", img:"../images/drinks/drink_soda_can.jpg", type:"drink" },
  { id:"coffee_mug", label:"Coffee", img:"../images/drinks/drink_coffee_mug.jpg", type:"drink" },
  { id:"toothbrush", label:"Toothbrush", img:"../images/other/other_toothbrush.jpg", type:"other" },
  { id:"spoon", label:"Spoon", img:"../images/other/other_spoon.jpg", type:"other" },
  { id:"cup_empty", label:"Cup", img:"../images/other/other_cup_empty.jpg", type:"other" },
  { id:"book", label:"Book", img:"../images/other/other_book.jpg", type:"other" },
  { id:"pencil", label:"Pencil", img:"../images/other/other_pencil.jpg", type:"other" },
  { id:"crayons", label:"Crayons", img:"../images/other/other_crayons.jpg", type:"other" },
  { id:"notebook", label:"Notebook", img:"../images/other/other_notebook.jpg", type:"other" },
  { id:"backpack", label:"Backpack", img:"../images/other/other_backpack.jpg", type:"other" },
  { id:"shoe", label:"Shoe", img:"../images/other/other_shoe.jpg", type:"other" },
  { id:"hat", label:"Hat", img:"../images/other/other_hat.jpg", type:"other" },
  { id:"jacket", label:"Jacket", img:"../images/other/other_jacket.jpg", type:"other" },
  { id:"shirt", label:"Shirt", img:"../images/other/other_shirt.jpg", type:"other" },
  { id:"socks", label:"Socks", img:"../images/other/other_socks.jpg", type:"other" },
  { id:"phone", label:"Phone", img:"../images/other/other_phone.jpg", type:"other" },
  { id:"keys", label:"Keys", img:"../images/other/other_keys.jpg", type:"other" },
  { id:"remote", label:"Remote", img:"../images/other/other_remote.jpg", type:"other" },
  { id:"clock", label:"Clock", img:"../images/other/other_clock.jpg", type:"other" },
  { id:"wallet", label:"Wallet", img:"../images/other/other_wallet.jpg", type:"other" },
  { id:"chair", label:"Chair", img:"../images/other/other_chair.jpg", type:"other" },
  { id:"table", label:"Table", img:"../images/other/other_table.jpg", type:"other" },
  { id:"ball", label:"Ball", img:"../images/other/other_ball.jpg", type:"other" },
  { id:"toy_car", label:"Toy Car", img:"../images/other/other_toy_car.jpg", type:"other" },
  { id:"teddy_bear", label:"Teddy Bear", img:"../images/other/other_teddy_bear.jpg", type:"other" },
  { id:"blocks", label:"Blocks", img:"../images/other/other_blocks.jpg", type:"other" },
  { id:"doll", label:"Doll", img:"../images/other/other_doll.jpg", type:"other" },
];

const ITEM_MAP = Object.fromEntries(ITEM_BANK.map(i => [i.id, i]));

const TRIALS_MASTER = [
  { targetId:"toothbrush", clues:[
      { text:"You use it to brush your teeth.", tag:"Function" },
      { text:"It has bristles and you keep it in the bathroom.", tag:"Feature/Class" },
    ],
    choices:["toothbrush","spoon","cup_empty","book","pencil","shoe","phone","ball"]
  },
  { targetId:"spoon", clues:[
      { text:"You use it to eat soup or cereal.", tag:"Function" },
      { text:"It's a kitchen utensil made of metal or plastic.", tag:"Class/Feature" },
    ],
    choices:["spoon","toothbrush","pencil","crayons","shoe","cup_empty","keys","book"]
  },
  { targetId:"book", clues:[
      { text:"You read it.", tag:"Function" },
      { text:"It has pages.", tag:"Feature" },
    ],
    choices:["book","notebook","phone","remote","pencil","toothbrush","wallet","ball"]
  },
  { targetId:"pencil", clues:[
      { text:"You use it to write or draw.", tag:"Function" },
      { text:"It has a point and can erase (sometimes).", tag:"Feature" },
    ],
    choices:["pencil","crayons","notebook","book","keys","remote","spoon","toy_car"]
  },
  { targetId:"crayons", clues:[
      { text:"You use them to color.", tag:"Function" },
      { text:"They come in many colors.", tag:"Feature" },
    ],
    choices:["crayons","pencil","notebook","book","toy_car","keys","spoon","hat"]
  },
  { targetId:"notebook", clues:[
      { text:"You write in it at school.", tag:"Function/Class" },
      { text:"It has blank or lined pages.", tag:"Feature" },
    ],
    choices:["notebook","book","pencil","crayons","backpack","wallet","remote","shoe"]
  },
  { targetId:"backpack", clues:[
      { text:"You carry school things in it.", tag:"Function" },
      { text:"You wear it on your back.", tag:"Class/Feature" },
    ],
    choices:["backpack","wallet","jacket","shirt","book","notebook","keys","toy_car"]
  },
  { targetId:"shoe", clues:[
      { text:"You wear it on your foot.", tag:"Function/Class" },
      { text:"It helps protect your feet when you walk.", tag:"Function" },
    ],
    choices:["shoe","socks","hat","jacket","shirt","backpack","ball","book"]
  },
  { targetId:"hat", clues:[
      { text:"You wear it on your head.", tag:"Function/Class" },
      { text:"It can keep the sun out of your eyes.", tag:"Function" },
    ],
    choices:["hat","shoe","jacket","shirt","socks","backpack","ball","keys"]
  },
  { targetId:"jacket", clues:[
      { text:"You wear it when it's cold.", tag:"Function" },
      { text:"It goes on top of your clothes.", tag:"Class" },
    ],
    choices:["jacket","shirt","socks","hat","shoe","backpack","wallet","toy_car"]
  },
  { targetId:"phone", clues:[
      { text:"You use it to call or text.", tag:"Function" },
      { text:"It has a screen.", tag:"Feature" },
    ],
    choices:["phone","remote","clock","wallet","keys","book","pencil","cup_empty"]
  },
  { targetId:"keys", clues:[
      { text:"You use them to unlock a door.", tag:"Function" },
      { text:"They are usually made of metal and on a key ring.", tag:"Feature" },
    ],
    choices:["keys","wallet","phone","remote","clock","book","spoon","shoe"]
  },
  { targetId:"remote", clues:[
      { text:"You use it to change the TV.", tag:"Function" },
      { text:"It has many buttons.", tag:"Feature" },
    ],
    choices:["remote","phone","clock","wallet","keys","book","pencil","toy_car"]
  },
  { targetId:"clock", clues:[
      { text:"It tells time.", tag:"Function" },
      { text:"It has numbers and hands (or a digital display).", tag:"Feature" },
    ],
    choices:["clock","phone","remote","wallet","keys","book","cup_empty","ball"]
  },
  { targetId:"wallet", clues:[
      { text:"You keep money or cards in it.", tag:"Function" },
      { text:"It fits in your pocket or bag.", tag:"Feature/Class" },
    ],
    choices:["wallet","backpack","keys","phone","remote","book","shoe","hat"]
  },
  { targetId:"chair", clues:[
      { text:"You sit on it.", tag:"Function" },
      { text:"It has legs and a seat.", tag:"Feature" },
    ],
    choices:["chair","table","backpack","book","shoe","ball","cup_empty","remote"]
  },
  { targetId:"table", clues:[
      { text:"You eat or do work on it.", tag:"Function" },
      { text:"It has a flat top and legs.", tag:"Feature" },
    ],
    choices:["table","chair","book","notebook","spoon","cup_empty","shoe","ball"]
  },
  { targetId:"ball", clues:[
      { text:"You throw it or kick it.", tag:"Function" },
      { text:"It is round.", tag:"Feature" },
    ],
    choices:["ball","toy_car","blocks","doll","teddy_bear","shoe","hat","book"]
  },
  { targetId:"toy_car", clues:[
      { text:"You play with it and roll it.", tag:"Function" },
      { text:"It has wheels.", tag:"Feature" },
    ],
    choices:["toy_car","ball","blocks","doll","teddy_bear","shoe","keys","book"]
  },
  { targetId:"teddy_bear", clues:[
      { text:"You hug it.", tag:"Function" },
      { text:"It is soft and stuffed.", tag:"Feature" },
    ],
    choices:["teddy_bear","doll","blocks","ball","toy_car","jacket","hat","book"]
  },
  { targetId:"blocks", clues:[
      { text:"You build with them.", tag:"Function" },
      { text:"They can stack on top of each other.", tag:"Feature" },
    ],
    choices:["blocks","ball","toy_car","doll","teddy_bear","book","shoe","backpack"]
  },
  { targetId:"doll", clues:[
      { text:"You pretend it's a person and play with it.", tag:"Function" },
      { text:"It looks like a person.", tag:"Feature/Class" },
    ],
    choices:["doll","teddy_bear","toy_car","blocks","ball","shirt","hat","book"]
  },
  { targetId:"apple", clues:[
      { text:"You eat it.", tag:"Function" },
      { text:"It is a fruit.", tag:"Class" },
    ],
    choices:["apple","water_bottle","shoe","book","ball","toothbrush","keys","pizza_slice"]
  },
  { targetId:"pizza_slice", clues:[
      { text:"You eat it for a meal.", tag:"Function" },
      { text:"It has cheese and sauce.", tag:"Feature" },
    ],
    choices:["pizza_slice","sandwich","water_bottle","book","shoe","ball","remote","keys"]
  },
  { targetId:"water_bottle", clues:[
      { text:"You drink from it.", tag:"Function" },
      { text:"It holds water and has a cap.", tag:"Feature" },
    ],
    choices:["water_bottle","milk_glass","juice_box","book","shoe","ball","keys","toothbrush"]
  },
];

const CONFIG = {
  fieldSize: 8,
  recycleDelayMin: 2,
  recycleDelayMax: 6,
};

let state = {
  ttsEnabled: true,
  indirectPromptEnabled: true,
  autoAdvanceClue: true,
  recycleOnly: false,

  trials: [],
  queue: [],
  recycled: [],
  current: null,

  trialIndex: 0,
  correct: 0,
  incorrect: 0,
  recycledCount: 0,

  clueIndex: 0,
  disabledIds: new Set(),
  locked: false,
  firstAttemptWrong: false,

  // Shuffled choice order for the current trial (re-rolled each trial)
  shuffledChoices: [],
};

function shuffle(arr){
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function speak(text){
  if (!state.ttsEnabled) return;
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
  window.speechSynthesis.speak(u);
}
function setFeedback(text, kind="neutral"){
  const el = document.getElementById("feedbackText");
  el.textContent = text;
  if (kind === "good") el.className = "fb-good good";
  else if (kind === "bad") el.className = "fb-neutral danger";
  else el.className = "fb-neutral";
}
function setPrompt(text){ document.getElementById("promptText").textContent = text || ""; }

function updateHeader(){
  document.getElementById("ttsLabel").textContent = state.ttsEnabled ? "On" : "Off";
}
function updateKPI(){
  document.getElementById("trialNum").textContent = String(Math.min(state.trialIndex + 1, 999));
  document.getElementById("trialTotal").textContent = String(state.trials.length);
  document.getElementById("kpiCorrect").textContent = String(state.correct);
  document.getElementById("kpiIncorrect").textContent = String(state.incorrect);
  document.getElementById("kpiRecycled").textContent = String(state.recycledCount);
}
function updateSD(){
  const clueTotal = state.current.clues.length;
  document.getElementById("clueNum").textContent = String(state.clueIndex + 1);
  document.getElementById("clueTotal").textContent = String(clueTotal);
  const clue = state.current.clues[state.clueIndex];
  document.getElementById("sdText").textContent = clue.text;
  document.getElementById("sdMeta").textContent = `Clue type: ${clue.tag}`;
}

function renderChoices(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  // Use the pre-shuffled order for this trial (stable across re-renders within a trial)
  const choices = state.shuffledChoices.map(id => ITEM_MAP[id]).filter(Boolean);

  choices.forEach(item => {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.setAttribute("role", "button");
    tile.setAttribute("tabindex", "0");

    const disabled = state.disabledIds.has(item.id) || state.locked;
    tile.setAttribute("aria-disabled", disabled ? "true" : "false");

    const pic = document.createElement("div");
    pic.className = "pic";

    const img = document.createElement("img");
    img.src = item.img;
    img.alt = item.label;
    img.loading = "lazy";
    img.onerror = () => {
      img.style.display = "none";
      const msg = document.createElement("div");
      msg.className = "mini danger";
      msg.textContent = "Image not found";
      pic.appendChild(msg);
    };
    pic.appendChild(img);

    const lbl = document.createElement("div");
    lbl.className = "lbl";
    lbl.textContent = item.label;

    tile.appendChild(pic);
    tile.appendChild(lbl);

    const activate = () => {
      if (tile.getAttribute("aria-disabled") === "true") return;
      onSelect(item.id);
    };
    tile.addEventListener("click", activate);
    tile.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); activate(); }
    });

    grid.appendChild(tile);
  });
}

function enableNext(enabled){
  document.getElementById("nextBtn").disabled = !enabled;
}

function indirectPromptText(){
  return "Try listening again. Think about what the clue is describing.";
}

function injectRecycledLater(trial){
  const delay = CONFIG.recycleDelayMin + Math.floor(Math.random() * (CONFIG.recycleDelayMax - CONFIG.recycleDelayMin + 1));
  const idx = Math.min(delay, state.queue.length);
  state.queue.splice(idx, 0, JSON.parse(JSON.stringify(trial)));
  state.recycledCount += 1;
  updateKPI();
}

function pullNextTrial(){
  if (state.recycleOnly) {
    if (state.recycled.length === 0) return null;
    return state.recycled.shift();
  }
  if (state.queue.length === 0) {
    if (state.recycled.length > 0) return state.recycled.shift();
    return null;
  }
  return state.queue.shift();
}

function startTrial(){
  state.clueIndex = 0;
  state.disabledIds = new Set();
  state.locked = false;
  state.firstAttemptWrong = false;

  // ‚úÖ THE FIX: shuffle the choices array fresh each trial so the
  // correct answer appears in a random position every time.
  state.shuffledChoices = shuffle(state.current.choices);

  enableNext(false);
  setFeedback("Select an answer.", "neutral");
  setPrompt("");

  updateHeader();
  updateKPI();
  updateSD();
  renderChoices();
}

function next(){
  const nxt = pullNextTrial();
  if (!nxt) {
    document.getElementById("grid").innerHTML = "";
    enableNext(false);
    document.getElementById("sdText").textContent = "Block complete.";
    document.getElementById("sdMeta").textContent = "";
    setFeedback("Nice job finishing the block!", "good");
    setPrompt("");
    return;
  }
  state.current = nxt;
  startTrial();
}

function onIncorrect(choiceId){
  state.incorrect += 1;
  state.firstAttemptWrong = true;

  if (state.clueIndex === 0) {
    setFeedback("Try again.", "bad");
    if (state.indirectPromptEnabled) {
      const p = indirectPromptText();
      setPrompt(p);
      speak(p);
    } else {
      setPrompt("");
    }
    if (state.autoAdvanceClue && state.current.clues.length > 1) {
      state.clueIndex = 1;
      updateSD();
    }
    updateKPI();
    return;
  }

  setFeedback("Try again.", "bad");
  state.disabledIds.add(choiceId);
  renderChoices();
  updateKPI();
}

function onCorrect(){
  state.correct += 1;
  state.locked = true;
  renderChoices();
  setFeedback("Nice job!", "good");
  setPrompt("");
  enableNext(true);
  updateKPI();
  if (state.firstAttemptWrong && !state.recycleOnly) {
    state.recycled.push(JSON.parse(JSON.stringify(state.current)));
  }
}

function onSelect(choiceId){
  if (!state.current) return;
  if (choiceId === state.current.targetId) onCorrect();
  else onIncorrect(choiceId);
}

document.getElementById("speakBtn").addEventListener("click", () => {
  const clue = state.current?.clues?.[state.clueIndex]?.text;
  if (clue) speak(clue);
});
document.getElementById("nextBtn").addEventListener("click", () => {
  state.trialIndex += 1;
  if (!state.recycleOnly && state.recycled.length > 0) {
    const t = state.recycled.shift();
    injectRecycledLater(t);
  }
  next();
});
document.getElementById("restartBtn").addEventListener("click", () => startSession());

document.getElementById("ttsToggle").addEventListener("change", (e) => {
  state.ttsEnabled = !!e.target.checked;
  updateHeader();
});
document.getElementById("indirectPromptToggle").addEventListener("change", (e) => {
  state.indirectPromptEnabled = !!e.target.checked;
});
document.getElementById("autoAdvanceClueToggle").addEventListener("change", (e) => {
  state.autoAdvanceClue = !!e.target.checked;
});

document.getElementById("runMissedBtn").addEventListener("click", () => {
  state.recycleOnly = true;
  setFeedback("Recycled-only block started.", "neutral");
  next();
});
document.getElementById("resumeMixedBtn").addEventListener("click", () => {
  state.recycleOnly = false;
  setFeedback("Mixed block resumed.", "neutral");
  next();
});
document.getElementById("resetDataBtn").addEventListener("click", () => {
  state.correct = 0;
  state.incorrect = 0;
  state.recycledCount = 0;
  state.trialIndex = 0;
  updateKPI();
  setFeedback("Data reset.", "neutral");
});

function startSession(){
  window.speechSynthesis?.cancel?.();
  state.correct = 0;
  state.incorrect = 0;
  state.recycledCount = 0;
  state.trialIndex = 0;
  state.recycleOnly = false;
  state.recycled = [];
  state.shuffledChoices = [];
  state.trials = TRIALS_MASTER.map(t => JSON.parse(JSON.stringify(t)));
  state.queue = shuffle(state.trials);
  updateHeader();
  updateKPI();
  next();
}

startSession();
</script>
</body>
</html>
