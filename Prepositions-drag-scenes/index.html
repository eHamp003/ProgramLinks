<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receptive Prepositions ‚Äî Drag & Drop Scenes</title>
  <style>
    :root{
      --gap: 12px;
      --radius: 16px;
      --border: 1px solid rgba(0,0,0,.12);
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f7f7f9;
      color:#111;
    }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card{
      background:#fff;
      border: var(--border);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    .row{ display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; }
    h1{ margin:0; font-size:18px; }
    .sub{ margin-top:4px; font-size:13px; color: rgba(0,0,0,.65); }

    .sd{
      margin-top: 10px;
      font-size: clamp(18px, 3vw, 28px);
      font-weight: 950;
      line-height: 1.2;
    }
    .sdmeta{ font-size: 12px; color: rgba(0,0,0,.6); margin-top:4px; }

    .controls{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 820px){
      .controls{ grid-template-columns: 1fr; }
    }
    .btn{
      border: var(--border);
      background: #fff;
      border-radius: 14px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 850;
    }
    .btn:hover{ box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }

    .kpi{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border: var(--border);
      background: #fbfbfd;
      font-weight: 850;
    }

    .layout{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    /* Scene */
    .sceneWrap{
      border: var(--border);
      border-radius: 20px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbff 100%);
      overflow: hidden;
    }
    .sceneHeader{
      padding: 10px 12px;
      border-bottom: var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .sceneTitle{ font-weight: 950; }
    .mini{ font-size: 12px; color: rgba(0,0,0,.65); }

    .scene{
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 10;
      background: radial-gradient(circle at 20% 10%, #fff6ff 0%, #f3fbff 35%, #f7f7f9 100%);
      touch-action: none; /* allow pointer dragging */
    }

    /* Static objects in scene */
    .obj{
      position:absolute;
      display:grid;
      place-items:center;
      user-select:none;
      pointer-events:none;
      transform: translate(-50%, -50%);
      text-align:center;
    }
    .obj .emoji{ font-size: clamp(30px, 5vw, 62px); line-height: 1; }
    .obj .label{ margin-top: 4px; font-size: 12px; font-weight: 850; color: rgba(0,0,0,.75); }

    /* Drop zones */
    .zone{
      position:absolute;
      transform: translate(-50%, -50%);
      border-radius: 18px;
      border: 2px dashed rgba(0,0,0,.15);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(2px);
      pointer-events:none;
      opacity: .45;
    }
    .zoneHint{
      position:absolute;
      inset: 0;
      display:grid;
      place-items:center;
      font-weight: 950;
      font-size: 12px;
      color: rgba(0,0,0,.35);
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .zone.highlight{
      opacity: 1;
      border-color: rgba(10,122,31,.9);
      box-shadow: 0 0 0 6px rgba(10,122,31,.18);
      animation: pulse 1.1s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 4px rgba(10,122,31,.12); }
      50%{ box-shadow: 0 0 0 10px rgba(10,122,31,.18); }
      100%{ box-shadow: 0 0 0 4px rgba(10,122,31,.12); }
    }

    /* Draggable item */
    .dragTray{
      border: var(--border);
      border-radius: 20px;
      padding: 12px;
      background: #fff;
      display:grid;
      gap: 10px;
      align-content:start;
    }
    .trayTitle{ font-weight: 950; }
    .draggable{
      border: var(--border);
      border-radius: 18px;
      background: #fff;
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items:center;
      cursor: grab;
      user-select:none;
      touch-action: none;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
    .draggable:active{ cursor: grabbing; }
    .draggable .emoji{ font-size: 44px; line-height: 1; }
    .draggable .text{ display:grid; gap:2px; }
    .draggable .name{ font-weight: 950; }
    .draggable .hint{ font-size: 12px; color: rgba(0,0,0,.6); }

    .feedback{
      border: var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      background: #fafafa;
    }
    .fbGood{ color: #0a7a1f; font-weight: 950; }
    .fbBad{ color: #b00020; font-weight: 850; }
    .fbNeutral{ color: rgba(0,0,0,.78); font-weight: 850; }

    details{ border: var(--border); border-radius: 20px; padding: 10px 12px; background:#fff; }
    summary{ cursor:pointer; font-weight: 950; }
    select, label input{ accent-color: #111; }
    .select{
      padding: 8px 10px;
      border-radius: 12px;
      border: var(--border);
      font-weight: 850;
      background: #fff;
    }

    /* Confetti (simple) */
    .confetti{
      position: fixed;
      inset: 0;
      pointer-events:none;
      overflow:hidden;
      z-index: 9999;
    }
    .confetti i{
      position:absolute;
      top:-14px;
      width: 10px;
      height: 14px;
      border-radius: 3px;
      opacity: .92;
      animation: fall linear forwards;
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(720deg); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h1>Receptive Prepositions ‚Äî Drag & Drop</h1>
          <div class="sub">Drag the item into the scene where the instruction says. Multiple scenes + error correction.</div>
        </div>
        <div class="row" style="justify-content:flex-end;">
          <span class="pill">Spoken SD: <span id="ttsLabel">On</span></span>
        </div>
      </div>

      <div class="sd" id="sdText">Loading‚Ä¶</div>
      <div class="sdmeta" id="sdMeta"></div>

      <div class="controls">
        <button class="btn" id="playBtn" type="button">üîä Play SD</button>
        <button class="btn" id="nextBtn" type="button" disabled>Next Trial</button>
        <button class="btn" id="restartBtn" type="button">Restart</button>
      </div>

      <div class="kpi">
        <span class="pill">Trial <span id="trialNum">1</span>/<span id="trialTotal">0</span></span>
        <span class="pill">Correct <span id="kpiCorrect">0</span></span>
        <span class="pill">Incorrect <span id="kpiIncorrect">0</span></span>
      </div>

      <div class="layout">
        <div class="sceneWrap">
          <div class="sceneHeader">
            <div>
              <div class="sceneTitle" id="sceneTitle">Scene</div>
              <div class="mini" id="sceneHint">Drag the item into the correct spot.</div>
            </div>
            <div class="mini">Zones are hidden during sessions (therapist can enable in panel).</div>
          </div>
          <div class="scene" id="scene"></div>
        </div>

        <div class="dragTray">
          <div class="trayTitle">Your item</div>

          <div class="draggable" id="draggable" role="button" tabindex="0" aria-label="Draggable item">
            <div class="emoji" id="dragEmoji">üß∏</div>
            <div class="text">
              <div class="name" id="dragName">Teddy</div>
              <div class="hint" id="dragHint">Drag me into the scene.</div>
            </div>
          </div>

          <div class="feedback">
            <div id="fbText" class="fbNeutral">Drag the item where the instruction says.</div>
            <div id="promptText" class="mini" style="margin-top:6px;"></div>
          </div>

          <details>
            <summary>‚öôÔ∏è Therapist Panel</summary>

            <div class="row" style="margin-top:10px;">
              <label style="display:flex; align-items:center; gap:10px;">
                <input id="ttsToggle" type="checkbox" checked />
                <span><strong>Spoken SD playback</strong></span>
              </label>

              <label style="display:flex; align-items:center; gap:10px;">
                <input id="showZonesToggle" type="checkbox" />
                <span><strong>Show drop zones</strong> <span class="mini">(for teaching/setup)</span></span>
              </label>
            </div>

            <div class="row" style="margin-top:10px;">
              <label style="display:flex; align-items:center; gap:10px;">
                <input id="autoPlaceToggle" type="checkbox" checked />
                <span><strong>Auto-place after 2 errors</strong></span>
              </label>

              <label style="display:flex; align-items:center; gap:10px;">
                <select id="prepFilter" class="select">
                  <option value="all" selected>Prepositions: All</option>
                  <option value="basic">Basic (on/in/under/next to)</option>
                  <option value="advanced">Advanced (between/inside/outside/above/below)</option>
                </select>
              </label>
            </div>

            <div class="mini" style="margin-top:10px;">
              Tip: This is a prototype. Add more scenes or trials by duplicating entries in <code>TRIALS</code>.
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>

  <div class="confetti" id="confetti"></div>

<script>
/* =========================
   Core helpers
========================= */
function shuffle(arr){
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function speak(text){
  if (!state.ttsEnabled) return;
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
  window.speechSynthesis.speak(u);
}
function confettiBurst(){
  const wrap = document.getElementById("confetti");
  wrap.innerHTML = "";
  const pieces = 28;
  for (let i = 0; i < pieces; i++){
    const p = document.createElement("i");
    p.style.left = (Math.random() * 100) + "vw";
    p.style.animationDuration = (1.1 + Math.random()*1.1) + "s";
    const hue = Math.floor(Math.random()*360);
    p.style.background = `hsl(${hue} 90% 60%)`;
    wrap.appendChild(p);
  }
  setTimeout(() => wrap.innerHTML = "", 1600);
}
function setFB(text, kind="neutral"){
  const el = document.getElementById("fbText");
  el.textContent = text;
  el.className = kind === "good" ? "fbGood" : (kind === "bad" ? "fbBad" : "fbNeutral");
}
function setPrompt(text=""){ document.getElementById("promptText").textContent = text; }

/* =========================
   Scenes + objects + zones
   All positioning uses percentages of the scene box.
========================= */
const SCENES = {
  livingroom: {
    title: "Living Room",
    objects: [
      { id:"couch", emoji:"üõãÔ∏è", label:"couch", x: 30, y: 55 },
      { id:"table", emoji:"ü™ë", label:"table", x: 68, y: 58 },
      { id:"box",   emoji:"üì¶", label:"box",   x: 76, y: 72 },
      { id:"lamp",  emoji:"üí°", label:"lamp",  x: 82, y: 42 },
    ],
    zones: [
      // id, label, x,y,w,h (all in %)
      { id:"on_couch",    label:"on",      anchor:"couch", x: 30, y: 42, w: 30, h: 20 },
      { id:"under_table", label:"under",   anchor:"table", x: 68, y: 78, w: 28, h: 18 },
      { id:"next_lamp",   label:"next to", anchor:"lamp",  x: 70, y: 42, w: 22, h: 22 },
      { id:"in_box",      label:"in",      anchor:"box",   x: 76, y: 74, w: 18, h: 18 },
      { id:"above_table", label:"above",   anchor:"table", x: 68, y: 35, w: 26, h: 18 },
      { id:"below_couch", label:"below",   anchor:"couch", x: 30, y: 78, w: 30, h: 18 },
    ],
    outsideArea: { id:"outside_room", label:"outside", x: 10, y: 15, w: 18, h: 20 } // ‚Äúoutside‚Äù demo
  },

  playground: {
    title: "Playground",
    objects: [
      { id:"slide", emoji:"üõù", label:"slide", x: 30, y: 60 },
      { id:"tree",  emoji:"üå≥", label:"tree",  x: 70, y: 45 },
      { id:"bench", emoji:"ü™ë", label:"bench", x: 70, y: 72 },
      { id:"tent",  emoji:"‚õ∫", label:"tent",  x: 46, y: 74 },
    ],
    zones: [
      { id:"on_bench",      label:"on",      anchor:"bench", x: 70, y: 58, w: 28, h: 18 },
      { id:"under_tree",    label:"under",   anchor:"tree",  x: 70, y: 62, w: 30, h: 26 },
      { id:"next_slide",    label:"next to", anchor:"slide", x: 50, y: 60, w: 24, h: 26 },
      { id:"inside_tent",   label:"inside",  anchor:"tent",  x: 46, y: 76, w: 26, h: 18 },
      { id:"outside_tent",  label:"outside", anchor:"tent",  x: 20, y: 78, w: 22, h: 18 },
      { id:"above_slide",   label:"above",   anchor:"slide", x: 30, y: 35, w: 26, h: 18 },
      { id:"below_bench",   label:"below",   anchor:"bench", x: 70, y: 88, w: 28, h: 16 },
    ]
  },

  bedroom: {
    title: "Bedroom",
    objects: [
      { id:"bed",   emoji:"üõèÔ∏è", label:"bed",   x: 34, y: 62 },
      { id:"pillow1",emoji:"üõå", label:"pillow",x: 24, y: 52 },
      { id:"pillow2",emoji:"üõå", label:"pillow",x: 44, y: 52 },
      { id:"drawer",emoji:"üóÑÔ∏è", label:"drawer",x: 76, y: 62 },
    ],
    zones: [
      { id:"on_bed",        label:"on",       anchor:"bed",    x: 34, y: 48, w: 32, h: 22 },
      { id:"under_bed",     label:"under",    anchor:"bed",    x: 34, y: 82, w: 34, h: 18 },
      { id:"between_pillows",label:"between", anchor:"pillow", x: 34, y: 52, w: 20, h: 18 },
      { id:"next_drawer",   label:"next to",  anchor:"drawer", x: 60, y: 62, w: 22, h: 24 },
      { id:"in_drawer",     label:"in",       anchor:"drawer", x: 76, y: 64, w: 22, h: 26 },
      { id:"above_bed",     label:"above",    anchor:"bed",    x: 34, y: 30, w: 30, h: 18 },
      { id:"below_drawer",  label:"below",    anchor:"drawer", x: 76, y: 86, w: 22, h: 16 },
    ]
  }
};

/* =========================
   Fun draggable items (the ‚Äúthing‚Äù the learner moves)
========================= */
const MOVE_ITEMS = [
  { id:"cat",   name:"cat",   emoji:"üê±" },
  { id:"kid",   name:"kid",   emoji:"üßí" },
  { id:"ball",  name:"ball",  emoji:"‚öΩ" },
  { id:"cake",  name:"cake",  emoji:"üç∞" },
  { id:"car",   name:"car",   emoji:"üöó" },
  { id:"duck",  name:"duck",  emoji:"ü¶Ü" },
  { id:"star",  name:"star",  emoji:"‚≠ê" },
  { id:"bear",  name:"bear",  emoji:"üß∏" },
];

/* =========================
   Trials
   - sceneId: which scene
   - moveId: which draggable item
   - prep: preposition
   - landmark: which object (for the text)
   - zoneId: which drop zone is correct
========================= */
const TRIALS_ALL = [
  // Living room
  { sceneId:"livingroom", moveId:"cat",  prep:"on",      landmark:"couch", zoneId:"on_couch" },
  { sceneId:"livingroom", moveId:"ball", prep:"under",   landmark:"table", zoneId:"under_table" },
  { sceneId:"livingroom", moveId:"star", prep:"next to", landmark:"lamp",  zoneId:"next_lamp" },
  { sceneId:"livingroom", moveId:"duck", prep:"in",      landmark:"box",   zoneId:"in_box" },
  { sceneId:"livingroom", moveId:"bear", prep:"above",   landmark:"table", zoneId:"above_table" },
  { sceneId:"livingroom", moveId:"car",  prep:"below",   landmark:"couch", zoneId:"below_couch" },

  // Playground
  { sceneId:"playground", moveId:"kid",  prep:"inside",  landmark:"tent",  zoneId:"inside_tent" },
  { sceneId:"playground", moveId:"ball", prep:"outside", landmark:"tent",  zoneId:"outside_tent" },
  { sceneId:"playground", moveId:"duck", prep:"under",   landmark:"tree",  zoneId:"under_tree" },
  { sceneId:"playground", moveId:"cat",  prep:"next to", landmark:"slide", zoneId:"next_slide" },
  { sceneId:"playground", moveId:"star", prep:"on",      landmark:"bench", zoneId:"on_bench" },
  { sceneId:"playground", moveId:"bear", prep:"above",   landmark:"slide", zoneId:"above_slide" },
  { sceneId:"playground", moveId:"car",  prep:"below",   landmark:"bench", zoneId:"below_bench" },

  // Bedroom
  { sceneId:"bedroom", moveId:"cat",  prep:"on",       landmark:"bed",    zoneId:"on_bed" },
  { sceneId:"bedroom", moveId:"ball", prep:"under",    landmark:"bed",    zoneId:"under_bed" },
  { sceneId:"bedroom", moveId:"star", prep:"between",  landmark:"pillows",zoneId:"between_pillows" },
  { sceneId:"bedroom", moveId:"duck", prep:"next to",  landmark:"drawer", zoneId:"next_drawer" },
  { sceneId:"bedroom", moveId:"bear", prep:"in",       landmark:"drawer", zoneId:"in_drawer" },
  { sceneId:"bedroom", moveId:"kid",  prep:"above",    landmark:"bed",    zoneId:"above_bed" },
  { sceneId:"bedroom", moveId:"cake", prep:"below",    landmark:"drawer", zoneId:"below_drawer" },
];

function prepCategory(prep){
  const basic = ["on","in","under","next to"];
  const advanced = ["between","inside","outside","above","below"];
  if (basic.includes(prep)) return "basic";
  if (advanced.includes(prep)) return "advanced";
  return "all";
}

/* =========================
   State
========================= */
let state = {
  ttsEnabled: true,
  showZones: false,
  autoPlaceAfter2: true,
  filter: "all",

  queue: [],
  current: null,

  errorsThisTrial: 0,
  correct: 0,
  incorrect: 0,

  dragging: false,
  dragOffset: { x: 0, y: 0 },
  dragStart: { x: 0, y: 0 },
};

/* =========================
   DOM refs
========================= */
const sceneEl = document.getElementById("scene");
const draggableEl = document.getElementById("draggable");

function updateHeader(){
  document.getElementById("ttsLabel").textContent = state.ttsEnabled ? "On" : "Off";
}
function updateKPI(){
  document.getElementById("trialTotal").textContent = String(state.queue.length + 1); // includes current remaining; gets reset in startSession
  document.getElementById("kpiCorrect").textContent = String(state.correct);
  document.getElementById("kpiIncorrect").textContent = String(state.incorrect);
}
function setTrialCounters(){
  document.getElementById("trialTotal").textContent = String(state.totalTrials);
  document.getElementById("trialNum").textContent = String(state.trialIndex + 1);
}
function sdTextFor(trial){
  const move = MOVE_ITEMS.find(x => x.id === trial.moveId);
  return `Put the ${move.name} ${trial.prep} the ${trial.landmark}.`;
}

/* =========================
   Render scene
========================= */
function clearScene(){
  sceneEl.innerHTML = "";
}
function renderScene(sceneId){
  clearScene();
  const scene = SCENES[sceneId];
  document.getElementById("sceneTitle").textContent = scene.title;

  // Static objects
  for (const o of scene.objects){
    const d = document.createElement("div");
    d.className = "obj";
    d.style.left = o.x + "%";
    d.style.top  = o.y + "%";
    d.innerHTML = `<div class="emoji">${o.emoji}</div><div class="label">${o.label}</div>`;
    sceneEl.appendChild(d);
  }

  // Drop zones
  const zones = scene.zones || [];
  for (const z of zones){
    const dz = document.createElement("div");
    dz.className = "zone";
    dz.dataset.zoneId = z.id;
    dz.style.left = z.x + "%";
    dz.style.top  = z.y + "%";
    dz.style.width  = z.w + "%";
    dz.style.height = z.h + "%";
    dz.style.opacity = state.showZones ? "0.75" : "0";
    dz.innerHTML = `<div class="zoneHint">${z.label}</div>`;
    sceneEl.appendChild(dz);
  }
}
function getZoneEl(zoneId){
  return sceneEl.querySelector(`.zone[data-zone-id="${zoneId}"]`) || sceneEl.querySelector(`.zone[data-zoneId="${zoneId}"]`);
}
function highlightZone(zoneId, on=true){
  for (const z of sceneEl.querySelectorAll(".zone")){
    z.classList.remove("highlight");
  }
  const el = sceneEl.querySelector(`.zone[data-zone-id="${zoneId}"]`) || sceneEl.querySelector(`.zone[data-zoneId="${zoneId}"]`);
  if (el && on) el.classList.add("highlight");
}

/* =========================
   Draggable item (pointer drag)
   - We drag a ‚Äúghost‚Äù inside the scene for accurate hit testing.
========================= */
let ghost = null;

function makeGhost(move){
  if (ghost) ghost.remove();
  ghost = document.createElement("div");
  ghost.style.position = "absolute";
  ghost.style.left = "10%";
  ghost.style.top  = "20%";
  ghost.style.transform = "translate(-50%,-50%)";
  ghost.style.width = "70px";
  ghost.style.height = "70px";
  ghost.style.display = "grid";
  ghost.style.placeItems = "center";
  ghost.style.fontSize = "54px";
  ghost.style.userSelect = "none";
  ghost.style.touchAction = "none";
  ghost.style.cursor = "grab";
  ghost.style.filter = "drop-shadow(0 10px 10px rgba(0,0,0,.12))";
  ghost.textContent = move.emoji;
  ghost.setAttribute("aria-label", "Drag item in scene");
  sceneEl.appendChild(ghost);
}

function resetGhostPosition(){
  if (!ghost) return;
  // left corner starter (in %)
  ghost.style.left = "12%";
  ghost.style.top  = "20%";
}

function sceneRect(){ return sceneEl.getBoundingClientRect(); }

function setGhostByClientXY(clientX, clientY){
  const r = sceneRect();
  const x = Math.max(0, Math.min(r.width,  clientX - r.left));
  const y = Math.max(0, Math.min(r.height, clientY - r.top));
  ghost.style.left = (x / r.width  * 100) + "%";
  ghost.style.top  = (y / r.height * 100) + "%";
}

function pointInZone(clientX, clientY, zoneEl){
  const zr = zoneEl.getBoundingClientRect();
  return clientX >= zr.left && clientX <= zr.right && clientY >= zr.top && clientY <= zr.bottom;
}

function handleDrop(clientX, clientY){
  const correctZoneId = state.current.zoneId;
  const zoneEl = sceneEl.querySelector(`.zone[data-zone-id="${correctZoneId}"]`) || sceneEl.querySelector(`.zone[data-zoneId="${correctZoneId}"]`);
  if (!zoneEl){
    // Shouldn't happen
    setFB("Oops ‚Äî missing zone.", "bad");
    return;
  }

  // Check if dropped inside the correct zone
  if (pointInZone(clientX, clientY, zoneEl)){
    // Snap to zone center
    const zr = zoneEl.getBoundingClientRect();
    const cx = (zr.left + zr.right) / 2;
    const cy = (zr.top + zr.bottom) / 2;
    setGhostByClientXY(cx, cy);

    document.getElementById("nextBtn").disabled = false;
    setFB("Nice job! üéâ", "good");
    setPrompt("");
    confettiBurst();
    highlightZone(correctZoneId, false);
    state.correct += 1;
    document.getElementById("kpiCorrect").textContent = String(state.correct);
    return;
  }

  // Incorrect
  state.incorrect += 1;
  document.getElementById("kpiIncorrect").textContent = String(state.incorrect);
  state.errorsThisTrial += 1;

  setFB("Try again.", "bad");
  setPrompt("Listen again, then try a different place.");
  resetGhostPosition();

  // After 1 error: highlight correct zone
  if (state.errorsThisTrial >= 1){
    highlightZone(correctZoneId, true);
  }

  // After 2 errors: optionally auto-place
  if (state.errorsThisTrial >= 2 && state.autoPlaceAfter2){
    const zr = zoneEl.getBoundingClientRect();
    const cx = (zr.left + zr.right) / 2;
    const cy = (zr.top + zr.bottom) / 2;
    setTimeout(() => {
      setGhostByClientXY(cx, cy);
      document.getElementById("nextBtn").disabled = false;
      setFB("That‚Äôs it. Nice try!", "good");
      setPrompt("Now press Next.");
      highlightZone(correctZoneId, false);
    }, 450);
  }
}

/* =========================
   Trial flow
========================= */
function buildQueue(){
  const filtered = TRIALS_ALL.filter(t => {
    if (state.filter === "all") return true;
    return prepCategory(t.prep) === state.filter;
  });
  return shuffle(filtered);
}

function startTrial(trial){
  state.current = trial;
  state.errorsThisTrial = 0;

  // Render scene
  renderScene(trial.sceneId);

  // Setup draggable
  const move = MOVE_ITEMS.find(x => x.id === trial.moveId) || MOVE_ITEMS[0];
  document.getElementById("dragEmoji").textContent = move.emoji;
  document.getElementById("dragName").textContent = move.name;
  document.getElementById("dragHint").textContent = "Drag me into the scene.";

  makeGhost(move);
  resetGhostPosition();

  // SD
  const sd = sdTextFor(trial);
  document.getElementById("sdText").textContent = sd;
  document.getElementById("sdMeta").textContent = `Scene: ${SCENES[trial.sceneId].title} ‚Ä¢ Target: ${trial.prep}`;
  document.getElementById("nextBtn").disabled = true;

  setFB("Drag the item where the instruction says.", "neutral");
  setPrompt("");
  highlightZone(trial.zoneId, false);
}

function nextTrial(){
  if (state.queue.length === 0){
    // done
    clearScene();
    document.getElementById("sdText").textContent = "All done! üåà";
    document.getElementById("sdMeta").textContent = "";
    document.getElementById("nextBtn").disabled = true;
    setFB("Great work finishing!", "good");
    setPrompt("");
    return;
  }
  state.trialIndex += 1;
  setTrialCounters();
  const t = state.queue.shift();
  startTrial(t);
}

function startSession(){
  window.speechSynthesis?.cancel?.();

  state.queue = buildQueue();
  state.totalTrials = state.queue.length;
  state.trialIndex = 0;

  state.correct = 0;
  state.incorrect = 0;
  document.getElementById("kpiCorrect").textContent = "0";
  document.getElementById("kpiIncorrect").textContent = "0";

  setTrialCounters();

  // Start first
  const first = state.queue.shift();
  startTrial(first);
}

function playSD(){
  const sd = document.getElementById("sdText").textContent;
  speak(sd);
}

/* =========================
   Pointer drag events on the ghost inside the scene
========================= */
function bindGhostDragging(){
  sceneEl.addEventListener("pointerdown", (e) => {
    // Only if ghost exists and pointer is near it
    if (!ghost) return;
    const gr = ghost.getBoundingClientRect();
    const hit = e.clientX >= gr.left && e.clientX <= gr.right && e.clientY >= gr.top && e.clientY <= gr.bottom;
    if (!hit) return;

    state.dragging = true;
    ghost.setPointerCapture(e.pointerId);
    state.dragStart = { x: e.clientX, y: e.clientY };
    setGhostByClientXY(e.clientX, e.clientY);
  });

  sceneEl.addEventListener("pointermove", (e) => {
    if (!state.dragging || !ghost) return;
    setGhostByClientXY(e.clientX, e.clientY);
  });

  sceneEl.addEventListener("pointerup", (e) => {
    if (!state.dragging || !ghost) return;
    state.dragging = false;
    try { ghost.releasePointerCapture(e.pointerId); } catch {}
    // If already correct and next enabled, don‚Äôt re-check
    if (!document.getElementById("nextBtn").disabled) return;
    handleDrop(e.clientX, e.clientY);
  });
}

/* =========================
   Controls + panel
========================= */
document.getElementById("playBtn").addEventListener("click", playSD);
document.getElementById("nextBtn").addEventListener("click", nextTrial);
document.getElementById("restartBtn").addEventListener("click", startSession);

document.getElementById("ttsToggle").addEventListener("change", (e) => {
  state.ttsEnabled = !!e.target.checked;
  updateHeader();
});
document.getElementById("showZonesToggle").addEventListener("change", (e) => {
  state.showZones = !!e.target.checked;
  // re-render current scene so opacity updates
  if (state.current) startTrial(state.current);
});
document.getElementById("autoPlaceToggle").addEventListener("change", (e) => {
  state.autoPlaceAfter2 = !!e.target.checked;
});
document.getElementById("prepFilter").addEventListener("change", (e) => {
  state.filter = e.target.value;
  startSession();
});

// Keyboard: allow ‚ÄúPlay SD‚Äù with Enter on draggable tray
draggableEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" || e.key === " ") { e.preventDefault(); playSD(); }
});

updateHeader();
bindGhostDragging();
startSession();
</script>
</body>
</html>
