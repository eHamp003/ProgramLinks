<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>VB-MAPP Sorting ‚Äî Colors & Shapes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #F5F0FF;
      --surface: #FFFFFF;
      --primary: #7C3AED;
      --primary-light: #EDE9FE;
      --accent: #F59E0B;
      --green: #10B981;
      --green-light: #D1FAE5;
      --red: #EF4444;
      --red-light: #FEE2E2;
      --text: #1E1B4B;
      --muted: #6B7280;
      --border: #E5E7EB;
      --font: 'Nunito', sans-serif;
      --radius: 20px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%; font-family: var(--font);
      background: var(--bg); color: var(--text);
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none; user-select: none;
    }
    #app {
      display: flex; flex-direction: column;
      height: 100dvh; max-width: 900px; margin: 0 auto;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 16px; background: var(--surface);
      border-bottom: 2px solid var(--primary-light); flex-shrink: 0;
    }
    .logo { font-size: 15px; font-weight: 900; color: var(--primary); white-space: nowrap; }
    .logo span { color: var(--accent); }
    #progressWrap {
      flex: 1; height: 12px; background: var(--primary-light);
      border-radius: 999px; overflow: hidden;
    }
    #progressBar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #A78BFA);
      border-radius: 999px; width: 0%;
      transition: width 0.5s cubic-bezier(.4,0,.2,1);
    }
    #levelBadge {
      font-size: 13px; font-weight: 800; color: var(--primary);
      background: var(--primary-light); padding: 4px 12px;
      border-radius: 999px; white-space: nowrap;
    }

    /* ‚îÄ‚îÄ STAR ROW ‚îÄ‚îÄ */
    #starRow {
      display: flex; flex-wrap: wrap; gap: 3px;
      padding: 5px 16px; flex-shrink: 0;
    }
    .star { font-size: 16px; filter: grayscale(1) opacity(0.3); transition: transform 0.3s, filter 0.3s; }
    .star.earned { filter: none; transform: scale(1.1); }
    .star.pop { animation: starPop 0.5s cubic-bezier(.36,.07,.19,.97); }
    @keyframes starPop {
      0%{transform:scale(1.1)} 30%{transform:scale(1.7)} 60%{transform:scale(0.9)} 100%{transform:scale(1.1)}
    }

    /* ‚îÄ‚îÄ INSTRUCTION BANNER ‚îÄ‚îÄ */
    #instructBanner {
      margin: 5px 16px; padding: 9px 14px;
      background: var(--surface); border-radius: 14px;
      border: 2px solid var(--primary-light);
      display: flex; align-items: center; gap: 10px; flex-shrink: 0;
    }
    #instructIcon { font-size: 26px; flex-shrink: 0; }
    #instructText { font-size: 14px; font-weight: 900; color: var(--primary); line-height: 1.3; }
    #instructSub  { font-size: 11px; font-weight: 600; color: var(--muted); }

    /* ‚îÄ‚îÄ GAME AREA ‚îÄ‚îÄ */
    #gameArea {
      flex: 1; display: flex; flex-direction: column;
      padding: 6px 16px 8px; gap: 8px; min-height: 0;
    }

    /* ‚îÄ‚îÄ TRAY ‚îÄ‚îÄ */
    #tray {
      background: var(--surface); border-radius: 16px;
      border: 2px solid var(--border);
      min-height: 100px;
      display: flex; flex-wrap: wrap;
      align-items: center; justify-content: center;
      gap: 8px; padding: 10px 12px;
      flex-shrink: 0; position: relative;
      transition: background 0.2s, border-color 0.2s;
    }
    #trayLabel {
      position: absolute; top: -10px; left: 14px;
      font-size: 10px; font-weight: 900; letter-spacing: 1.2px;
      text-transform: uppercase; color: var(--muted);
      background: var(--surface); padding: 0 6px;
    }

    /* ‚îÄ‚îÄ BIN ROW ‚îÄ‚îÄ */
    #binRow {
      display: flex; gap: 8px; flex: 1; min-height: 0;
    }

    .bin {
      flex: 1; border-radius: var(--radius);
      border: 3px dashed var(--border); background: var(--surface);
      display: flex; flex-direction: column;
      align-items: center; padding: 8px 6px 6px;
      gap: 5px; min-height: 0; overflow: hidden;
      transition: border-color 0.2s, background 0.2s, transform 0.15s;
    }
    .bin.drag-over {
      border-color: var(--primary); background: var(--primary-light);
      transform: scale(1.02);
    }
    .bin.correct-flash {
      border-color: var(--green); background: var(--green-light);
      animation: binPop 0.45s ease;
    }
    .bin.error-flash {
      border-color: var(--red); background: var(--red-light);
      animation: binShake 0.4s ease;
    }
    @keyframes binPop { 0%{transform:scale(1)} 40%{transform:scale(1.04)} 100%{transform:scale(1)} }
    @keyframes binShake {
      0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)}
      40%{transform:translateX(8px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)}
    }

    /* Bin header: icon + label */
    .bin-head {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      flex-shrink: 0;
    }
    .bin-icon {
      width: 48px; height: 48px; border-radius: 10px;
      object-fit: cover; border: 3px solid var(--border);
      background: #f3f3f3;
    }
    .bin-icon.color-swatch {
      border-radius: 10px;
    }
    .bin-label {
      font-size: 11px; font-weight: 900; color: var(--muted);
      text-align: center; letter-spacing: 0.3px;
    }

    /* Placed pieces inside bin */
    .bin-pieces {
      display: flex; flex-wrap: wrap; gap: 5px;
      justify-content: center; align-items: flex-start;
      flex: 1; overflow-y: auto; width: 100%;
    }

    /* ‚îÄ‚îÄ PIECE CARDS ‚îÄ‚îÄ */
    .piece {
      width: 76px; height: 76px;
      border-radius: 14px;
      border: 3px solid rgba(0,0,0,0.07);
      cursor: grab;
      display: grid; place-items: center;
      flex-shrink: 0; overflow: hidden;
      transition: transform 0.12s, box-shadow 0.12s, opacity 0.15s;
      box-shadow: 0 4px 14px rgba(0,0,0,0.12);
      animation: pieceIn 0.4s cubic-bezier(.36,.07,.19,.97) both;
      position: relative; background: #f8f8f8;
      touch-action: none;
    }
    .piece img {
      width: 100%; height: 100%;
      object-fit: cover; pointer-events: none;
      border-radius: 11px;
    }
    /* Loading shimmer */
    .piece::before {
      content: "";
      position: absolute; inset: 0;
      background: linear-gradient(90deg, #eee 25%, #f5f5f5 50%, #eee 75%);
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
      border-radius: 11px;
      z-index: 0;
    }
    .piece img.loaded { position: relative; z-index: 1; }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .piece.dragging {
      cursor: grabbing; opacity: 0.5;
      transform: scale(1.1) rotate(3deg);
      box-shadow: 0 14px 30px rgba(0,0,0,0.22);
      z-index: 999;
    }
    .piece.placed {
      width: 54px; height: 54px;
      border-radius: 10px; cursor: default;
      pointer-events: none;
      animation: piecePlace 0.35s cubic-bezier(.36,.07,.19,.97);
    }
    .piece.placed img { border-radius: 7px; }
    @keyframes pieceIn {
      from { transform: scale(0.6) rotate(-8deg); opacity: 0; }
      to   { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    @keyframes piecePlace {
      0%{transform:scale(1.3)} 60%{transform:scale(0.9)} 100%{transform:scale(1)}
    }

    /* piece label tooltip on hover */
    .piece-label {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(30,27,75,0.75); color: #fff;
      font-size: 9px; font-weight: 800; text-align: center;
      padding: 2px 2px; border-radius: 0 0 10px 10px;
      opacity: 0; transition: opacity 0.2s;
      pointer-events: none; z-index: 2;
    }
    .piece:hover .piece-label { opacity: 1; }

    /* ‚îÄ‚îÄ FEEDBACK ‚îÄ‚îÄ */
    #feedbackBar {
      padding: 3px 16px 6px; min-height: 34px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .fb-pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 7px 18px; border-radius: 999px;
      font-size: 14px; font-weight: 800;
      opacity: 0; transform: translateY(6px);
      transition: opacity 0.2s, transform 0.2s;
    }
    .fb-pill.show { opacity: 1; transform: translateY(0); }
    .fb-pill.ok  { background: var(--green-light); color: #065F46; }
    .fb-pill.no  { background: var(--red-light);   color: #991B1B; }

    /* ‚îÄ‚îÄ GHOST ‚îÄ‚îÄ */
    #dragGhost {
      position: fixed; pointer-events: none; z-index: 9999;
      transform: translate(-50%,-50%) scale(1.1) rotate(4deg);
      display: none;
    }

    /* ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ */
    #confettiLayer { position:fixed;inset:0;pointer-events:none;z-index:9999; }
    .cp {
      position: absolute; border-radius: 2px;
      animation: cpFall linear forwards;
    }
    @keyframes cpFall {
      0%  { transform:translateY(-20px) rotate(0deg); opacity:1; }
      100%{ transform:translateY(100vh) rotate(720deg); opacity:0; }
    }

    /* ‚îÄ‚îÄ REWARD ‚îÄ‚îÄ */
    #rewardScreen {
      position:fixed;inset:0;z-index:500;
      background:rgba(124,58,237,0.93); backdrop-filter:blur(6px);
      display:none; flex-direction:column; align-items:center;
      justify-content:center; gap:12px; text-align:center; color:#fff;
    }
    #rewardScreen.show { display:flex; }
    #rewardEmoji { font-size:88px; animation:rBounce 0.6s cubic-bezier(.36,.07,.19,.97); }
    @keyframes rBounce {
      0%{transform:scale(0) rotate(-20deg)} 60%{transform:scale(1.2) rotate(5deg)} 100%{transform:scale(1)}
    }
    #rewardTitle { font-size:32px; font-weight:900; }
    #rewardSub   { font-size:16px; font-weight:700; opacity:0.85; }
    #rewardBtn {
      margin-top:8px; background:#fff; color:var(--primary);
      border:none; padding:13px 34px; border-radius:999px;
      font-size:16px; font-weight:900; font-family:var(--font); cursor:pointer;
    }

    /* ‚îÄ‚îÄ DONE ‚îÄ‚îÄ */
    #doneScreen {
      position:fixed;inset:0;z-index:600;
      background:linear-gradient(160deg,#1E1B4B 0%,#4C1D95 100%);
      display:none; flex-direction:column; align-items:center;
      justify-content:center; gap:12px; text-align:center; color:#fff;
    }
    #doneScreen.show { display:flex; }
    #doneTitle { font-size:28px; font-weight:900; }
    #doneScore { font-size:58px; font-weight:900; color:var(--accent); }
    #doneStats { font-size:16px; opacity:0.85; }
    #doneBtn {
      margin-top:6px; background:var(--accent); color:#1E1B4B;
      border:none; padding:13px 32px; border-radius:999px;
      font-size:16px; font-weight:900; font-family:var(--font); cursor:pointer;
    }
    #doneAccBar { width:200px;height:13px;background:rgba(255,255,255,0.2);border-radius:999px;overflow:hidden; }
    #doneAccFill { height:100%;background:var(--accent);border-radius:999px;width:0%;transition:width 1s cubic-bezier(.4,0,.2,1); }

    /* ‚îÄ‚îÄ HOT CORNER ‚îÄ‚îÄ */
    #hotCorner { position:fixed;left:0;top:0;width:50px;height:50px;z-index:1000;opacity:0.001; }

    @media (max-width:480px) {
      .piece { width:64px; height:64px; }
      .piece.placed { width:46px; height:46px; }
      .bin-icon { width:38px; height:38px; }
    }
  </style>
</head>
<body>

<div id="app">
  <header>
    <div class="logo">VB-MAPP <span>‚òÖ</span> Sort</div>
    <div id="progressWrap"><div id="progressBar"></div></div>
    <div id="levelBadge">Level 1</div>
  </header>

  <div id="starRow"></div>

  <div id="instructBanner">
    <div id="instructIcon">üé®</div>
    <div>
      <div id="instructText">Sort by Color!</div>
      <div id="instructSub">Drag each picture into the matching color bin</div>
    </div>
  </div>

  <div id="gameArea">
    <div id="tray"><div id="trayLabel">Pieces to sort</div></div>
    <div id="binRow"></div>
  </div>

  <div id="feedbackBar"><div class="fb-pill" id="fbPill"></div></div>
</div>

<div id="dragGhost"></div>
<div id="confettiLayer"></div>
<div id="hotCorner"></div>

<!-- REWARD -->
<div id="rewardScreen">
  <div id="rewardEmoji">üåü</div>
  <div id="rewardTitle">Amazing!</div>
  <div id="rewardSub"></div>
  <button id="rewardBtn">Next Round ‚Üí</button>
</div>

<!-- DONE -->
<div id="doneScreen">
  <div style="font-size:54px">üèÜ</div>
  <div id="doneTitle">All Done!</div>
  <div id="doneScore"></div>
  <div id="doneStats"></div>
  <div id="doneAccBar"><div id="doneAccFill"></div></div>
  <button id="doneBtn" onclick="restartGame()">Play Again üéâ</button>
</div>

<script>
/* =================================================================
   IMAGE DATA
   Using Unsplash Source API: https://source.unsplash.com/featured/?{keyword}&w=300&h=300
   Each item: { label, color, shape, url }
   ================================================================= */

// Reliable Unsplash photo IDs for each item (hand-picked for clarity)
// Format: https://images.unsplash.com/photo-{id}?w=300&h=300&fit=crop&auto=format
function img(id, fallbackEmoji) {
  return { url: `https://images.unsplash.com/photo-${id}?w=300&h=300&fit=crop&auto=format&q=80`, emoji: fallbackEmoji };
}

/* ‚îÄ‚îÄ COLOR ITEMS (4 per color) ‚îÄ‚îÄ */
const COLOR_DATA = {
  red: {
    label: "Red",
    swatch: "#E53E3E",
    items: [
      { label:"apple",       ...img("1567306301-8bc765d3-b6f8-4e77-92aa-c8dc934c1777", "üçé") },
      { label:"strawberry",  ...img("1464965911861-746a04b4bca6", "üçì") },
      { label:"fire truck",  ...img("1558618666-fcd25c85cd64", "üöí") },
      { label:"red ball",    ...img("1576423902053-97c1e1a0e7b4", "üî¥") },
    ]
  },
  blue: {
    label: "Blue",
    swatch: "#3182CE",
    items: [
      { label:"blueberries", ...img("1498557850523-fd3d118b962e", "ü´ê") },
      { label:"blue shirt",  ...img("1521572163474-6864f9cf17ab", "üëï") },
      { label:"blue cup",    ...img("1577937927133-66ef06acdf18", "ü•§") },
      { label:"blue crayon", ...img("1513542789411-b6a5d4f31634", "üñçÔ∏è") },
    ]
  },
  green: {
    label: "Green",
    swatch: "#38A169",
    items: [
      { label:"broccoli",    ...img("1459411621453-7b03977f4bfc", "ü•¶") },
      { label:"frog",        ...img("1531946803-48f4fa29c53d", "üê∏") },
      { label:"green apple", ...img("1585059895524-72359e06133a", "üçè") },
      { label:"turtle",      ...img("1497752531616-c3afd9760a11", "üê¢") },
    ]
  },
  yellow: {
    label: "Yellow",
    swatch: "#D69E2E",
    items: [
      { label:"banana",      ...img("1528825871115-3581a5387919", "üçå") },
      { label:"school bus",  ...img("1558618644-e6e6e0e8b877", "üöå") },
      { label:"sunflower",   ...img("1490750967868-88df5691cc3d", "üåª") },
      { label:"lemon",       ...img("1582979512210-d2a4e1519b2b", "üçã") },
    ]
  },
  orange: {
    label: "Orange",
    swatch: "#DD6B20",
    items: [
      { label:"orange",      ...img("1547514701-42782101795e", "üçä") },
      { label:"carrot",      ...img("1598170845058-32b9d6a5da37", "ü•ï") },
      { label:"basketball",  ...img("1546519638-68e109498ffc", "üèÄ") },
      { label:"tiger",       ...img("1561731216-c3a4d99437d5", "üêØ") },
    ]
  },
};

/* ‚îÄ‚îÄ SHAPE ITEMS (4 per shape) ‚îÄ‚îÄ */
const SHAPE_DATA = {
  round: {
    label: "Round",
    icon: "‚≠ï",
    items: [
      { label:"orange",      ...img("1547514701-42782101795e", "üçä") },
      { label:"clock",       ...img("1563861826100-9cb868fdbe1c", "üïí") },
      { label:"ball",        ...img("1576423902053-97c1e1a0e7b4", "‚öΩ") },
      { label:"pizza",       ...img("1513104890138-7c749659a591", "üçï") },
    ]
  },
  square: {
    label: "Square / Rectangle",
    icon: "‚ñ≠",
    items: [
      { label:"book",        ...img("1544716278-ca5e3f4abd8c", "üìï") },
      { label:"cereal box",  ...img("1619566636145-17c7c0a4c1f9", "üì¶") },
      { label:"picture frame",...img("1513519245088-0e12902e5a38", "üñºÔ∏è") },
      { label:"tablet",      ...img("1561154464-02ce0a1eb084", "üì±") },
    ]
  },
  pointy: {
    label: "Pointy / Triangle",
    icon: "üî∫",
    items: [
      { label:"party hat",   ...img("1530103862676-de8c9debad1d", "üéâ") },
      { label:"ice cream cone",...img("1557142046-c704a3adf364", "üç¶") },
      { label:"carrot",      ...img("1598170845058-32b9d6a5da37", "ü•ï") },
      { label:"pine tree",   ...img("1545259741-2ea3ebf61fa3", "üå≤") },
    ]
  },
};

/* =================================================================
   LEVEL PLAN ‚Äî alternating color / shape, bins grow 2‚Üí3‚Üí4‚Üí3‚Üí...
   ================================================================= */
const LEVEL_PLAN = [
  // Level 1: Color, 2 bins
  { mode:"color", bins:2, colors:["red","blue"],
    label:"Sort by Color!", icon:"üé®", sub:"Drag each picture into the matching color bin" },
  // Level 2: Shape, 2 bins
  { mode:"shape", bins:2, shapes:["round","square"],
    label:"Sort by Shape!", icon:"üî∑", sub:"Does it have curves or straight edges?" },
  // Level 3: Color, 3 bins
  { mode:"color", bins:3, colors:["red","green","yellow"],
    label:"3 Colors ‚Äî Sort Them!", icon:"üé®", sub:"Three color bins ‚Äî you can do it!" },
  // Level 4: Shape, 3 bins
  { mode:"shape", bins:3, shapes:["round","square","pointy"],
    label:"3 Shapes ‚Äî Sort Them!", icon:"üî∑", sub:"Round, square, or pointy ‚Äî where does it go?" },
  // Level 5: Color, 4 bins
  { mode:"color", bins:4, colors:["red","blue","green","yellow"],
    label:"4 Colors ‚Äî Expert Mode!", icon:"üåà", sub:"Four color groups ‚Äî amazing job!" },
  // Level 6: Color, 5 bins (all colors)
  { mode:"color", bins:5, colors:["red","blue","green","yellow","orange"],
    label:"All 5 Colors ‚Äî Champion!", icon:"üèÜ", sub:"Sort all five colors like a champion!" },
  // Level 7: Shape, 3 bins (repeat with harder timing expectation)
  { mode:"shape", bins:3, shapes:["round","square","pointy"],
    label:"Shape Master!", icon:"‚≠ê", sub:"You know your shapes ‚Äî show it off!" },
];

const TOTAL_LEVELS = LEVEL_PLAN.length;

/* =================================================================
   STATE
   ================================================================= */
const G = {
  level: 0,
  correctCount: 0,
  errorCount: 0,
  pieces: [],
  bins: [],
  dragging: null,
  locked: false,
};

const D = {
  tray:         document.getElementById("tray"),
  binRow:       document.getElementById("binRow"),
  starRow:      document.getElementById("starRow"),
  progressBar:  document.getElementById("progressBar"),
  levelBadge:   document.getElementById("levelBadge"),
  instructIcon: document.getElementById("instructIcon"),
  instructText: document.getElementById("instructText"),
  instructSub:  document.getElementById("instructSub"),
  fbPill:       document.getElementById("fbPill"),
  confetti:     document.getElementById("confettiLayer"),
  rewardScreen: document.getElementById("rewardScreen"),
  rewardEmoji:  document.getElementById("rewardEmoji"),
  rewardTitle:  document.getElementById("rewardTitle"),
  rewardSub:    document.getElementById("rewardSub"),
  rewardBtn:    document.getElementById("rewardBtn"),
  doneScreen:   document.getElementById("doneScreen"),
  doneScore:    document.getElementById("doneScore"),
  doneStats:    document.getElementById("doneStats"),
  doneAccFill:  document.getElementById("doneAccFill"),
  ghost:        document.getElementById("dragGhost"),
};

/* =================================================================
   INIT
   ================================================================= */
function init() {
  buildStarRow();
  loadLevel();
  D.rewardBtn.addEventListener("click", advanceLevel);
  document.getElementById("hotCorner").addEventListener("click", () =>
    alert(`Level ${G.level+1}/${TOTAL_LEVELS} | ‚úì ${G.correctCount} | ‚úó ${G.errorCount}`)
  );
}

function buildStarRow() {
  D.starRow.innerHTML = "";
  for (let i = 0; i < TOTAL_LEVELS; i++) {
    const s = document.createElement("div");
    s.className = "star"; s.textContent = "‚≠ê"; s.id = `star-${i}`;
    D.starRow.appendChild(s);
  }
}

/* =================================================================
   LEVEL LOADER
   ================================================================= */
function loadLevel() {
  G.locked = false; G.dragging = null;
  const plan = LEVEL_PLAN[G.level];

  D.levelBadge.textContent   = `Level ${G.level + 1}`;
  D.progressBar.style.width  = `${(G.level / TOTAL_LEVELS) * 100}%`;
  D.instructIcon.textContent = plan.icon;
  D.instructText.textContent = plan.label;
  D.instructSub.textContent  = plan.sub;

  D.tray.innerHTML = '<div id="trayLabel">Pieces to sort</div>';
  D.binRow.innerHTML = "";
  G.pieces = []; G.bins = [];

  if (plan.mode === "color") buildColorLevel(plan);
  else                        buildShapeLevel(plan);

  setFeedback(null);
  speak(plan.label);
}

/* ‚îÄ‚îÄ COLOR LEVEL ‚îÄ‚îÄ */
function buildColorLevel(plan) {
  plan.colors.forEach(colorKey => {
    const fam = COLOR_DATA[colorKey];

    // Build bin
    const { binEl, piecesArea } = createBin(colorKey, fam.label);

    // Color swatch as bin icon
    const swatch = document.createElement("div");
    swatch.className = "bin-icon color-swatch";
    swatch.style.background = fam.swatch;
    swatch.style.border = `3px solid rgba(0,0,0,0.1)`;
    binEl.querySelector(".bin-head").prepend(swatch);

    D.binRow.appendChild(binEl);
    G.bins.push({ id: colorKey, el: binEl, piecesArea, count: 0, total: fam.items.length });

    // Create pieces
    fam.items.forEach((item, i) => {
      const piece = createPiece(colorKey, item, i);
      G.pieces.push(piece);
    });
  });

  shuffleIntoTray();
}

/* ‚îÄ‚îÄ SHAPE LEVEL ‚îÄ‚îÄ */
function buildShapeLevel(plan) {
  // Use a single accent color for all pieces so shape is the only cue
  plan.shapes.forEach(shapeKey => {
    const fam = SHAPE_DATA[shapeKey];

    const { binEl, piecesArea } = createBin(shapeKey, fam.label);

    // Shape icon emoji as bin hint
    const iconEl = document.createElement("div");
    iconEl.className = "bin-icon";
    iconEl.style.cssText = `
      display:grid;place-items:center;
      background:var(--primary-light);
      border:3px solid var(--primary);
      font-size:22px;
    `;
    iconEl.textContent = fam.icon;
    binEl.querySelector(".bin-head").prepend(iconEl);

    D.binRow.appendChild(binEl);
    G.bins.push({ id: shapeKey, el: binEl, piecesArea, count: 0, total: fam.items.length });

    fam.items.forEach((item, i) => {
      const piece = createPiece(shapeKey, item, i);
      G.pieces.push(piece);
    });
  });

  shuffleIntoTray();
}

/* ‚îÄ‚îÄ CREATE BIN ‚îÄ‚îÄ */
function createBin(id, label) {
  const binEl = document.createElement("div");
  binEl.className = "bin"; binEl.dataset.bid = id;

  const head = document.createElement("div");
  head.className = "bin-head";

  const lbl = document.createElement("div");
  lbl.className = "bin-label"; lbl.textContent = label;
  head.appendChild(lbl);

  const piecesArea = document.createElement("div");
  piecesArea.className = "bin-pieces";

  binEl.appendChild(head);
  binEl.appendChild(piecesArea);
  return { binEl, piecesArea };
}

/* ‚îÄ‚îÄ CREATE PIECE ‚îÄ‚îÄ */
function createPiece(binId, item, idx) {
  const el = document.createElement("div");
  el.className = "piece";
  el.style.animationDelay = (idx * 0.06) + "s";
  el.setAttribute("aria-label", item.label);
  el.setAttribute("tabindex", "0");
  el.dataset.binId = binId;

  const pid = binId + "_" + idx;
  el.dataset.pid = pid;

  // Image
  const imgEl = document.createElement("img");
  imgEl.alt = item.label;
  imgEl.loading = "lazy";

  // Fallback: if image fails, show emoji
  imgEl.onerror = () => {
    el.style.background = "#f0f0f0";
    el.style.fontSize = "36px";
    el.innerHTML = "";
    el.textContent = item.emoji || "üì∑";
    const lb = document.createElement("div");
    lb.className = "piece-label"; lb.textContent = item.label;
    el.appendChild(lb);
  };
  imgEl.onload = () => imgEl.classList.add("loaded");
  imgEl.src = item.url;
  el.appendChild(imgEl);

  // Label overlay
  const lbl = document.createElement("div");
  lbl.className = "piece-label"; lbl.textContent = item.label;
  el.appendChild(lbl);

  const p = { id: pid, binId, el, placed: false };
  attachDrag(p);
  return p;
}

function shuffleIntoTray() {
  shuffle(G.pieces).forEach(p => D.tray.appendChild(p.el));
}

/* =================================================================
   DRAG & DROP ‚Äî unified mouse + touch
   ================================================================= */
function attachDrag(piece) {
  const el = piece.el;
  el.addEventListener("mousedown",  e => startDrag(piece, e.clientX, e.clientY, e));
  el.addEventListener("touchstart", e => {
    const t = e.touches[0];
    startDrag(piece, t.clientX, t.clientY, e);
  }, { passive: false });
}

function startDrag(piece, cx, cy, e) {
  if (G.locked || piece.placed) return;
  e.preventDefault();
  G.dragging = piece;
  piece.el.classList.add("dragging");

  // Build ghost
  const clone = piece.el.cloneNode(true);
  clone.style.width  = piece.el.offsetWidth  + "px";
  clone.style.height = piece.el.offsetHeight + "px";
  clone.style.animationName = "none";
  clone.classList.remove("dragging");
  D.ghost.innerHTML = "";
  D.ghost.appendChild(clone);
  D.ghost.style.display = "block";
  moveGhost(cx, cy);

  const onMove = (ex, ey) => { moveGhost(ex, ey); highlightBins(ex, ey); };
  const onEnd  = (ex, ey) => {
    D.ghost.style.display = "none";
    clearBinHighlights();
    const bin = binUnder(ex, ey);
    if (bin) handleDrop(piece, bin);
    else     piece.el.classList.remove("dragging");
    G.dragging = null;
    document.removeEventListener("mousemove", mm);
    document.removeEventListener("mouseup",   mu);
    document.removeEventListener("touchmove", tm);
    document.removeEventListener("touchend",  te);
  };

  const mm = e => onMove(e.clientX, e.clientY);
  const mu = e => onEnd(e.clientX, e.clientY);
  const tm = e => { e.preventDefault(); const t=e.touches[0]; onMove(t.clientX,t.clientY); };
  const te = e => { const t=e.changedTouches[0]; onEnd(t.clientX,t.clientY); };

  document.addEventListener("mousemove", mm);
  document.addEventListener("mouseup",   mu);
  document.addEventListener("touchmove", tm, { passive:false });
  document.addEventListener("touchend",  te);
}

function moveGhost(cx, cy) {
  D.ghost.style.left = cx + "px"; D.ghost.style.top = cy + "px";
}

function binUnder(cx, cy) {
  for (const b of document.querySelectorAll(".bin")) {
    const r = b.getBoundingClientRect();
    if (cx >= r.left && cx <= r.right && cy >= r.top && cy <= r.bottom) return b;
  }
  return null;
}

function highlightBins(cx, cy) {
  document.querySelectorAll(".bin").forEach(b => {
    const r = b.getBoundingClientRect();
    const over = cx>=r.left && cx<=r.right && cy>=r.top && cy<=r.bottom;
    b.classList.toggle("drag-over", over);
  });
}

function clearBinHighlights() {
  document.querySelectorAll(".bin").forEach(b => b.classList.remove("drag-over"));
}

/* =================================================================
   DROP LOGIC
   ================================================================= */
function handleDrop(piece, binEl) {
  piece.el.classList.remove("dragging");
  if (binEl.dataset.bid === piece.binId) handleCorrect(piece, binEl);
  else                                    handleError(piece, binEl);
}

function handleCorrect(piece, binEl) {
  piece.placed = true;
  G.correctCount++;

  piece.el.classList.add("placed");
  const binState = G.bins.find(b => b.id === binEl.dataset.bid);
  binState.piecesArea.appendChild(piece.el);
  binState.count++;

  binEl.classList.add("correct-flash");
  setTimeout(() => binEl.classList.remove("correct-flash"), 500);

  beep(880,90); setTimeout(()=>beep(1100,70),110);
  launchConfetti(binEl);

  const praise = ["Nice! ‚≠ê","Yes! üéâ","Great! üåü","Correct! ‚ú®","Awesome! ü•≥","Perfect! üíú"];
  setFeedback("ok", praise[Math.floor(Math.random()*praise.length)]);

  checkLevelComplete();
}

function handleError(piece, binEl) {
  G.errorCount++;
  beep(260, 170);
  binEl.classList.add("error-flash");
  setTimeout(() => binEl.classList.remove("error-flash"), 500);
  setFeedback("no", "Try again! üëÄ");
  speak("Try again.");
}

function checkLevelComplete() {
  if (!G.pieces.every(p => p.placed)) return;
  G.locked = true;

  const starEl = document.getElementById(`star-${G.level}`);
  if (starEl) {
    starEl.classList.add("earned");
    setTimeout(() => { starEl.classList.add("pop"); setTimeout(()=>starEl.classList.remove("pop"),550); }, 100);
  }

  setTimeout(() => {
    bigConfetti();
    if (G.level >= TOTAL_LEVELS - 1) setTimeout(showDoneScreen, 900);
    else showReward();
  }, 350);
}

/* =================================================================
   REWARD
   ================================================================= */
const REWARDS = [
  { emoji:"üåü", title:"Superstar!",  sub:"You sorted them all correctly!" },
  { emoji:"üéâ", title:"Woohoo!",     sub:"Amazing sorting skills!" },
  { emoji:"ü¶Å", title:"So Smart!",   sub:"You're a sorting champion!" },
  { emoji:"üèÜ", title:"Gold Star!",  sub:"Keep up the great work!" },
  { emoji:"üåà", title:"Brilliant!",  sub:"You know your colors and shapes!" },
  { emoji:"üöÄ", title:"Blast Off!",  sub:"To the next level!" },
  { emoji:"ü¶ã", title:"Beautiful!",  sub:"Just like a butterfly ‚Äî amazing!" },
];

function showReward() {
  const r = REWARDS[G.level % REWARDS.length];
  D.rewardEmoji.textContent = r.emoji;
  D.rewardTitle.textContent = r.title;
  D.rewardSub.textContent   = r.sub;
  D.rewardScreen.classList.add("show");
  beep(660,80); setTimeout(()=>beep(880,80),110); setTimeout(()=>beep(1100,130),240);
}

function advanceLevel() {
  D.rewardScreen.classList.remove("show");
  G.level++;
  if (G.level >= TOTAL_LEVELS) { showDoneScreen(); return; }
  setTimeout(loadLevel, 200);
}

/* =================================================================
   DONE SCREEN
   ================================================================= */
function showDoneScreen() {
  const total = G.correctCount + G.errorCount;
  const acc = total > 0 ? Math.round((G.correctCount / total) * 100) : 100;
  D.doneScore.textContent = acc + "% üéØ";
  D.doneStats.textContent = `${G.correctCount} correct placements`;
  D.doneScreen.classList.add("show");
  D.progressBar.style.width = "100%";
  setTimeout(() => { D.doneAccFill.style.width = acc + "%"; }, 400);
  bigConfetti();
}

function restartGame() {
  G.level=0; G.correctCount=0; G.errorCount=0;
  D.doneScreen.classList.remove("show");
  buildStarRow(); loadLevel();
}

/* =================================================================
   CONFETTI
   ================================================================= */
const CC = ["#7C3AED","#F59E0B","#10B981","#EF4444","#3B82F6","#EC4899","#FBBF24","#34D399"];
function launchConfetti(anchor) {
  const r = anchor.getBoundingClientRect();
  for (let i=0;i<14;i++) {
    const p=document.createElement("div"); p.className="cp";
    p.style.left=(r.left+r.width/2+(Math.random()-0.5)*60)+"px";
    p.style.top=r.top+"px";
    p.style.background=CC[i%CC.length];
    p.style.width=(7+Math.random()*7)+"px"; p.style.height=(7+Math.random()*7)+"px";
    p.style.borderRadius=Math.random()>0.5?"50%":"2px";
    p.style.animationDuration=(0.6+Math.random()*0.5)+"s";
    p.style.animationDelay=(Math.random()*0.15)+"s";
    D.confetti.appendChild(p); p.addEventListener("animationend",()=>p.remove());
  }
}
function bigConfetti() {
  for (let i=0;i<65;i++) {
    const p=document.createElement("div"); p.className="cp";
    p.style.left=Math.random()*100+"vw"; p.style.top="-10px";
    p.style.background=CC[i%CC.length];
    p.style.width=(8+Math.random()*10)+"px"; p.style.height=(8+Math.random()*10)+"px";
    p.style.borderRadius=Math.random()>0.5?"50%":"3px";
    p.style.animationDuration=(1.2+Math.random()*1.2)+"s";
    p.style.animationDelay=(Math.random()*0.8)+"s";
    D.confetti.appendChild(p); p.addEventListener("animationend",()=>p.remove());
  }
}

/* =================================================================
   FEEDBACK + AUDIO
   ================================================================= */
function setFeedback(type, text) {
  D.fbPill.className="fb-pill"; D.fbPill.textContent=text||"";
  if(text){ void D.fbPill.offsetWidth; D.fbPill.classList.add("show", type||"ok"); }
}

let _ctx=null;
function getCtx(){ if(!_ctx) _ctx=new(window.AudioContext||window.webkitAudioContext)(); return _ctx; }
function beep(freq=880,ms=110){
  try{
    const ctx=getCtx(),o=ctx.createOscillator(),g=ctx.createGain();
    o.type="sine";o.frequency.value=freq;g.gain.value=0.07;
    o.connect(g);g.connect(ctx.destination);o.start();
    setTimeout(()=>{try{o.stop();}catch(e){}},ms);
  }catch(e){}
}
function speak(text){
  if(!("speechSynthesis" in window))return;
  window.speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.rate=0.92;u.pitch=1.08;
  window.speechSynthesis.speak(u);
}

function shuffle(arr){
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}

window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
