<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>VB-MAPP Sorting ‚Äî Colors & Shapes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #F5F0FF;
      --surface: #FFFFFF;
      --primary: #7C3AED;
      --primary-light: #EDE9FE;
      --accent: #F59E0B;
      --green: #10B981;
      --green-light: #D1FAE5;
      --red: #EF4444;
      --red-light: #FEE2E2;
      --text: #1E1B4B;
      --muted: #6B7280;
      --border: #E5E7EB;
      --font: 'Nunito', sans-serif;
      --radius: 20px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%; font-family: var(--font);
      background: var(--bg); color: var(--text);
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none; user-select: none;
    }
    #app {
      display: flex; flex-direction: column;
      height: 100dvh; max-width: 900px; margin: 0 auto;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 16px;
      background: var(--surface);
      border-bottom: 2px solid var(--primary-light);
      flex-shrink: 0;
    }
    .logo { font-size: 15px; font-weight: 900; color: var(--primary); white-space: nowrap; }
    .logo span { color: var(--accent); }
    #progressWrap {
      flex: 1; height: 12px; background: var(--primary-light);
      border-radius: 999px; overflow: hidden;
    }
    #progressBar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #A78BFA);
      border-radius: 999px; width: 0%;
      transition: width 0.5s cubic-bezier(.4,0,.2,1);
    }
    #levelBadge {
      font-size: 13px; font-weight: 800; color: var(--primary);
      background: var(--primary-light); padding: 4px 12px;
      border-radius: 999px; white-space: nowrap;
    }

    /* ‚îÄ‚îÄ STAR ROW ‚îÄ‚îÄ */
    #starRow {
      display: flex; flex-wrap: wrap; gap: 3px;
      padding: 5px 16px 3px; flex-shrink: 0;
    }
    .star { font-size: 16px; filter: grayscale(1) opacity(0.3); transition: transform 0.3s, filter 0.3s; }
    .star.earned { filter: none; transform: scale(1.1); }
    .star.pop { animation: starPop 0.5s cubic-bezier(.36,.07,.19,.97); }
    @keyframes starPop {
      0%{transform:scale(1.1)} 30%{transform:scale(1.7)} 60%{transform:scale(0.9)} 100%{transform:scale(1.1)}
    }

    /* ‚îÄ‚îÄ INSTRUCTION BANNER ‚îÄ‚îÄ */
    #instructBanner {
      margin: 5px 16px; padding: 9px 14px;
      background: var(--surface); border-radius: 14px;
      border: 2px solid var(--primary-light);
      display: flex; align-items: center; gap: 10px;
      flex-shrink: 0;
    }
    #instructIcon { font-size: 26px; flex-shrink: 0; }
    #instructText { font-size: 14px; font-weight: 900; color: var(--primary); }
    #instructSub  { font-size: 12px; font-weight: 600; color: var(--muted); }

    /* ‚îÄ‚îÄ GAME AREA ‚îÄ‚îÄ */
    #gameArea {
      flex: 1; display: flex; flex-direction: column;
      padding: 5px 16px 8px; gap: 8px; min-height: 0;
    }

    /* ‚îÄ‚îÄ TRAY ‚îÄ‚îÄ */
    #tray {
      background: var(--surface); border-radius: var(--radius);
      border: 2px solid var(--border);
      min-height: 108px;
      display: flex; flex-wrap: wrap;
      align-items: center; justify-content: center;
      gap: 8px; padding: 10px 12px;
      flex-shrink: 0; position: relative;
    }
    #trayLabel {
      position: absolute; top: -10px; left: 16px;
      font-size: 10px; font-weight: 900; letter-spacing: 1.5px;
      text-transform: uppercase; color: var(--muted);
      background: var(--surface); padding: 0 6px;
    }

    /* ‚îÄ‚îÄ BINS ‚îÄ‚îÄ */
    #binRow { display: flex; gap: 8px; flex: 1; min-height: 0; }

    .bin {
      flex: 1; border-radius: var(--radius);
      border: 3px dashed var(--border);
      background: var(--surface);
      display: flex; flex-direction: column;
      align-items: center; padding: 8px 6px 6px;
      gap: 5px; min-height: 0; overflow: hidden;
      transition: border-color 0.2s, background 0.2s, transform 0.15s;
    }
    .bin.drag-over {
      border-color: var(--primary); background: var(--primary-light); transform: scale(1.02);
    }
    .bin.correct-flash {
      border-color: var(--green); background: var(--green-light);
      animation: binFlash 0.5s ease;
    }
    .bin.error-flash {
      border-color: var(--red); background: var(--red-light);
      animation: binShake 0.4s ease;
    }
    @keyframes binFlash { 0%{transform:scale(1)} 40%{transform:scale(1.04)} 100%{transform:scale(1)} }
    @keyframes binShake {
      0%,100%{transform:translateX(0)} 20%{transform:translateX(-7px)}
      50%{transform:translateX(7px)} 80%{transform:translateX(-4px)}
    }

    .bin-label {
      font-size: 11px; font-weight: 900; color: var(--muted);
      text-align: center; letter-spacing: 0.3px; flex-shrink: 0;
    }

    /* Bin hint swatch / icon */
    .bin-hint {
      width: 44px; height: 44px; border-radius: 12px;
      border: 3px solid rgba(0,0,0,0.1); flex-shrink: 0;
      display: grid; place-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      font-size: 24px; line-height: 1;
    }

    .bin-pieces {
      display: flex; flex-wrap: wrap; gap: 5px;
      justify-content: center; align-items: flex-start;
      flex: 1; overflow-y: auto; width: 100%;
    }

    /* ‚îÄ‚îÄ PIECE CARDS ‚îÄ‚îÄ */
    .piece {
      width: 80px; height: 80px;
      border-radius: 16px;
      border: 3px solid var(--border);
      background: #fff;
      cursor: grab;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 4px; flex-shrink: 0;
      transition: transform 0.12s, box-shadow 0.12s, opacity 0.15s;
      box-shadow: 0 4px 14px rgba(0,0,0,0.09);
      animation: pieceIn 0.4s cubic-bezier(.36,.07,.19,.97) both;
      touch-action: none;
    }
    /* staggered entrance */
    .piece:nth-child(1){animation-delay:.03s} .piece:nth-child(2){animation-delay:.07s}
    .piece:nth-child(3){animation-delay:.11s} .piece:nth-child(4){animation-delay:.15s}
    .piece:nth-child(5){animation-delay:.19s} .piece:nth-child(6){animation-delay:.23s}
    .piece:nth-child(7){animation-delay:.27s} .piece:nth-child(8){animation-delay:.31s}
    .piece:nth-child(9){animation-delay:.35s} .piece:nth-child(10){animation-delay:.39s}
    .piece:nth-child(11){animation-delay:.43s} .piece:nth-child(12){animation-delay:.47s}
    .piece:nth-child(13){animation-delay:.51s} .piece:nth-child(14){animation-delay:.55s}
    .piece:nth-child(15){animation-delay:.59s} .piece:nth-child(16){animation-delay:.63s}
    .piece:nth-child(17){animation-delay:.67s} .piece:nth-child(18){animation-delay:.71s}
    .piece:nth-child(19){animation-delay:.75s} .piece:nth-child(20){animation-delay:.79s}

    @keyframes pieceIn {
      from { transform: scale(0.6) rotate(-8deg); opacity: 0; }
      to   { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    .piece.dragging { opacity: 0.4; transform: scale(1.08) rotate(3deg); cursor: grabbing; }

    .piece-emoji {
      font-size: 42px; line-height: 1; pointer-events: none;
    }
    .piece-label {
      font-size: 9px; font-weight: 800; color: var(--muted);
      text-align: center; pointer-events: none;
      padding: 0 4px; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis; width: 100%;
    }

    /* Placed (smaller inside bin) */
    .piece.placed {
      width: 58px; height: 58px; border-radius: 12px;
      cursor: default; pointer-events: none;
      animation: piecePlace 0.35s cubic-bezier(.36,.07,.19,.97);
    }
    .piece.placed .piece-emoji { font-size: 30px; }
    .piece.placed .piece-label { font-size: 8px; }
    @keyframes piecePlace {
      0%{transform:scale(1.3)} 60%{transform:scale(0.92)} 100%{transform:scale(1)}
    }

    /* ‚îÄ‚îÄ FEEDBACK ‚îÄ‚îÄ */
    #feedbackBar {
      padding: 3px 16px 6px; min-height: 34px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .fb-pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 7px 18px; border-radius: 999px;
      font-size: 14px; font-weight: 800;
      opacity: 0; transform: translateY(6px);
      transition: opacity 0.2s, transform 0.2s;
    }
    .fb-pill.show { opacity: 1; transform: translateY(0); }
    .fb-pill.ok  { background: var(--green-light); color: #065F46; }
    .fb-pill.no  { background: var(--red-light);   color: #991B1B; }

    /* ‚îÄ‚îÄ DRAG GHOST ‚îÄ‚îÄ */
    #dragGhost {
      position: fixed; pointer-events: none; z-index: 9999;
      transform: translate(-50%,-50%) scale(1.12) rotate(4deg);
      display: none;
    }

    /* ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ */
    #confettiLayer { position:fixed; inset:0; pointer-events:none; z-index:9998; }
    .cp { position:absolute; border-radius:2px; animation: cpFall linear forwards; }
    @keyframes cpFall {
      0%  { transform:translateY(-20px) rotate(0deg); opacity:1; }
      100%{ transform:translateY(100vh)  rotate(720deg); opacity:0; }
    }

    /* ‚îÄ‚îÄ REWARD ‚îÄ‚îÄ */
    #rewardScreen {
      position:fixed; inset:0; z-index:500;
      background:rgba(124,58,237,0.93); backdrop-filter:blur(6px);
      display:none; flex-direction:column; align-items:center;
      justify-content:center; gap:12px; text-align:center; color:#fff;
    }
    #rewardScreen.show { display:flex; }
    #rewardEmoji { font-size:88px; animation:rBounce 0.6s cubic-bezier(.36,.07,.19,.97); }
    @keyframes rBounce {
      0%{transform:scale(0) rotate(-20deg)} 60%{transform:scale(1.2) rotate(5deg)} 100%{transform:scale(1)}
    }
    #rewardTitle { font-size:32px; font-weight:900; }
    #rewardSub   { font-size:16px; font-weight:700; opacity:.85; }
    #rewardBtn {
      margin-top:8px; background:#fff; color:var(--primary);
      border:none; padding:14px 34px; border-radius:999px;
      font-size:17px; font-weight:900; font-family:var(--font); cursor:pointer;
    }

    /* ‚îÄ‚îÄ DONE ‚îÄ‚îÄ */
    #doneScreen {
      position:fixed; inset:0; z-index:600;
      background:linear-gradient(160deg,#1E1B4B 0%,#4C1D95 100%);
      display:none; flex-direction:column; align-items:center;
      justify-content:center; gap:12px; text-align:center; color:#fff;
    }
    #doneScreen.show { display:flex; }
    #doneTitle { font-size:30px; font-weight:900; }
    #doneScore { font-size:60px; font-weight:900; color:var(--accent); }
    #doneStats { font-size:16px; opacity:.85; }
    #doneAccBar { width:200px; height:14px; background:rgba(255,255,255,0.2); border-radius:999px; overflow:hidden; }
    #doneAccFill { height:100%; background:var(--accent); border-radius:999px; width:0%; transition:width 1s cubic-bezier(.4,0,.2,1); }
    #doneBtn {
      margin-top:6px; background:var(--accent); color:#1E1B4B;
      border:none; padding:14px 34px; border-radius:999px;
      font-size:17px; font-weight:900; font-family:var(--font); cursor:pointer;
    }

    /* ‚îÄ‚îÄ HOT CORNER ‚îÄ‚îÄ */
    #hotCorner { position:fixed; left:0; top:0; width:50px; height:50px; z-index:1000; opacity:.001; }

    /* Responsive */
    @media(max-width:520px){
      .piece { width:68px; height:68px; }
      .piece-emoji { font-size:36px; }
      .piece.placed { width:50px; height:50px; }
      .piece.placed .piece-emoji { font-size:26px; }
    }
  </style>
</head>
<body>

<div id="app">
  <header>
    <div class="logo">VB-MAPP <span>‚òÖ</span> Sort</div>
    <div id="progressWrap"><div id="progressBar"></div></div>
    <div id="levelBadge">Level 1</div>
  </header>
  <div id="starRow"></div>
  <div id="instructBanner">
    <div id="instructIcon">üé®</div>
    <div>
      <div id="instructText">Sort by color!</div>
      <div id="instructSub">Drag each picture into the matching color bin</div>
    </div>
  </div>
  <div id="gameArea">
    <div id="tray"><div id="trayLabel">Pieces to sort</div></div>
    <div id="binRow"></div>
  </div>
  <div id="feedbackBar"><div class="fb-pill" id="fbPill"></div></div>
</div>

<div id="dragGhost"></div>
<div id="confettiLayer"></div>

<div id="rewardScreen">
  <div id="rewardEmoji">üåü</div>
  <div id="rewardTitle">Amazing!</div>
  <div id="rewardSub"></div>
  <button id="rewardBtn">Next Round ‚Üí</button>
</div>

<div id="doneScreen">
  <div style="font-size:54px">üèÜ</div>
  <div id="doneTitle">All Done!</div>
  <div id="doneScore"></div>
  <div id="doneStats"></div>
  <div id="doneAccBar"><div id="doneAccFill"></div></div>
  <button id="doneBtn" onclick="restartGame()">Play Again üéâ</button>
</div>

<div id="hotCorner"></div>

<script>
/* ================================================================
   ITEM DATABASE ‚Äî emoji-based real items
   ================================================================ */

// Color sorting items ‚Äî 4 clearly colored real items per color
const COLOR_ITEMS = {
  red: {
    label: "Red", swatch: "#E53E3E",
    items: [
      { id:"apple",      label:"apple",       emoji:"üçé" },
      { id:"strawberry", label:"strawberry",  emoji:"üçì" },
      { id:"firetruck",  label:"fire truck",  emoji:"üöí" },
      { id:"redballoon", label:"balloon",     emoji:"üéà" },
    ]
  },
  blue: {
    label: "Blue", swatch: "#3182CE",
    items: [
      { id:"bluehat",     label:"blue hat",    emoji:"üß¢" },
      { id:"blueheart",   label:"blue heart",  emoji:"üíô" },
      { id:"whale",      label:"whale",       emoji:"üêã" },
      { id:"raindrop",   label:"water drop",  emoji:"üíß" },
    ]
  },
  green: {
    label: "Green", swatch: "#38A169",
    items: [
      { id:"broccoli",   label:"broccoli",    emoji:"ü•¶" },
      { id:"frog",       label:"frog",        emoji:"üê∏" },
      { id:"greenapple", label:"green apple", emoji:"üçè" },
      { id:"turtle",     label:"turtle",      emoji:"üê¢" },
    ]
  },
  yellow: {
    label: "Yellow", swatch: "#D69E2E",
    items: [
      { id:"banana",     label:"banana",      emoji:"üçå" },
      { id:"schoolbus",  label:"school bus",  emoji:"üöå" },
      { id:"sunflower",  label:"sunflower",   emoji:"üåª" },
      { id:"lemon",      label:"lemon",       emoji:"üçã" },
    ]
  },
  orange: {
    label: "Orange", swatch: "#DD6B20",
    items: [
      { id:"orange",     label:"orange",      emoji:"üçä" },
      { id:"carrot",     label:"carrot",      emoji:"ü•ï" },
      { id:"basketball", label:"basketball",  emoji:"üèÄ" },
      { id:"tiger",      label:"tiger",       emoji:"üêØ" },
    ]
  },
};

// Shape sorting items ‚Äî 4 real items that clearly represent each shape
const SHAPE_ITEMS = {
  round: {
    label: "Round", icon: "‚≠ï",
    items: [
      { id:"s_ball",    label:"ball",        emoji:"‚öΩ" },
      { id:"s_orange",  label:"orange",      emoji:"üçä" },
      { id:"s_clock",   label:"clock",       emoji:"üïí" },
      { id:"s_donut",   label:"donut",       emoji:"üç©" },
    ]
  },
  rect: {
    label: "Rectangle", icon: "‚ñ≠",
    items: [
      { id:"s_book",    label:"book",        emoji:"üìï" },
      { id:"s_phone",   label:"phone",       emoji:"üì±" },
      { id:"s_laptop",  label:"laptop",      emoji:"üíª" },
      { id:"s_door",    label:"door",        emoji:"üö™" },
    ]
  },
  triangle: {
    label: "Pointy", icon: "üî∫",
    items: [
      { id:"s_pizza",   label:"pizza slice", emoji:"üçï" },
      { id:"s_warning",   label:"warning sign", emoji:"‚ö†Ô∏è" },
      { id:"s_redflag",   label:"red flag",     emoji:"üö©" },
      { id:"s_carrot",  label:"carrot",      emoji:"ü•ï" },
    ]
  },
};

/* ================================================================
   LEVEL PLAN ‚Äî alternates color ‚Üí shape, bins grow 2 ‚Üí 3 ‚Üí 4/5
   ================================================================ */
const LEVEL_PLAN = [
  { mode:"color", bins:2, keys:["red","blue"],
    label:"Sort by Color!", icon:"üé®", sub:"2 colors ‚Äî drag each picture to its matching bin" },
  { mode:"shape", bins:2, keys:["round","rect"],
    label:"Sort by Shape!", icon:"üî∑", sub:"Round or rectangle ‚Äî look carefully!" },
  { mode:"color", bins:3, keys:["red","blue","green"],
    label:"Sort by Color!", icon:"üé®", sub:"3 colors now ‚Äî you've got this!" },
  { mode:"shape", bins:3, keys:["round","rect","triangle"],
    label:"Sort by Shape!", icon:"üî∫", sub:"3 shape groups ‚Äî great sorting skills!" },
  { mode:"color", bins:4, keys:["red","blue","green","yellow"],
    label:"Color Expert!",  icon:"üåà", sub:"4 colors ‚Äî amazing work!" },
  { mode:"color", bins:5, keys:["red","blue","green","yellow","orange"],
    label:"Rainbow Master!", icon:"üåà", sub:"All 5 colors ‚Äî the ultimate challenge!" },
];

const TOTAL_LEVELS = LEVEL_PLAN.length;

/* ================================================================
   GAME STATE
   ================================================================ */
const G = {
  level: 0,
  correctCount: 0,
  errorCount: 0,
  pieces: [],
  bins: [],
  dragging: null,
  locked: false,
};

const D = {
  tray:         document.getElementById("tray"),
  binRow:       document.getElementById("binRow"),
  starRow:      document.getElementById("starRow"),
  progressBar:  document.getElementById("progressBar"),
  levelBadge:   document.getElementById("levelBadge"),
  instructIcon: document.getElementById("instructIcon"),
  instructText: document.getElementById("instructText"),
  instructSub:  document.getElementById("instructSub"),
  fbPill:       document.getElementById("fbPill"),
  confetti:     document.getElementById("confettiLayer"),
  rewardScreen: document.getElementById("rewardScreen"),
  rewardEmoji:  document.getElementById("rewardEmoji"),
  rewardTitle:  document.getElementById("rewardTitle"),
  rewardSub:    document.getElementById("rewardSub"),
  rewardBtn:    document.getElementById("rewardBtn"),
  doneScreen:   document.getElementById("doneScreen"),
  doneScore:    document.getElementById("doneScore"),
  doneStats:    document.getElementById("doneStats"),
  doneAccFill:  document.getElementById("doneAccFill"),
  ghost:        document.getElementById("dragGhost"),
};

/* ================================================================
   INIT
   ================================================================ */
function init() {
  buildStarRow();
  loadLevel();
  D.rewardBtn.addEventListener("click", advanceLevel);
  document.getElementById("hotCorner").addEventListener("click", () => {
    alert(`Session Stats\nLevel: ${G.level+1}/${TOTAL_LEVELS}\nCorrect: ${G.correctCount}\nErrors: ${G.errorCount}`);
  });
}

function buildStarRow() {
  D.starRow.innerHTML = "";
  for (let i = 0; i < TOTAL_LEVELS; i++) {
    const s = document.createElement("div");
    s.className = "star"; s.textContent = "‚≠ê"; s.id = `star-${i}`;
    D.starRow.appendChild(s);
  }
}

/* ================================================================
   LEVEL LOADER
   ================================================================ */
function loadLevel() {
  G.locked = false; G.dragging = null;
  G.pieces = []; G.bins = [];
  const plan = LEVEL_PLAN[G.level];

  D.levelBadge.textContent   = `Level ${G.level + 1}`;
  D.progressBar.style.width  = `${(G.level / TOTAL_LEVELS) * 100}%`;
  D.instructIcon.textContent = plan.icon;
  D.instructText.textContent = plan.label;
  D.instructSub.textContent  = plan.sub;

  D.tray.innerHTML   = '<div id="trayLabel">Pieces to sort</div>';
  D.binRow.innerHTML = "";

  plan.mode === "color" ? buildColorLevel(plan) : buildShapeLevel(plan);
  setFeedback(null);
  speak(plan.label);
}

/* ‚îÄ‚îÄ COLOR LEVEL ‚îÄ‚îÄ */
function buildColorLevel(plan) {
  plan.keys.forEach(colorKey => {
    const group = COLOR_ITEMS[colorKey];

    // Bin
    const binEl = createBinEl(colorKey, group.label);
    const hint  = binEl.querySelector(".bin-hint");
    hint.style.background  = group.swatch;
    hint.style.borderColor = group.swatch;
    D.binRow.appendChild(binEl);
    G.bins.push({ id: colorKey, el: binEl, count: 0, total: group.items.length });

    // Pieces
    group.items.forEach((item, i) => {
      G.pieces.push(createPiece(item, colorKey, i));
    });
  });

  shuffle(G.pieces).forEach(p => D.tray.appendChild(p.el));
}

/* ‚îÄ‚îÄ SHAPE LEVEL ‚îÄ‚îÄ */
function buildShapeLevel(plan) {
  plan.keys.forEach(shapeKey => {
    const group = SHAPE_ITEMS[shapeKey];

    // Bin
    const binEl = createBinEl(shapeKey, group.label);
    const hint  = binEl.querySelector(".bin-hint");
    hint.style.background  = "#EDE9FE";
    hint.style.borderColor = "#C4B5FD";
    hint.textContent = group.icon;
    D.binRow.appendChild(binEl);
    G.bins.push({ id: shapeKey, el: binEl, count: 0, total: group.items.length });

    // Pieces
    group.items.forEach((item, i) => {
      G.pieces.push(createPiece(item, shapeKey, i));
    });
  });

  shuffle(G.pieces).forEach(p => D.tray.appendChild(p.el));
}

/* ‚îÄ‚îÄ CREATE BIN ‚îÄ‚îÄ */
function createBinEl(id, label) {
  const bin = document.createElement("div");
  bin.className = "bin"; bin.dataset.bid = id;

  const lbl    = document.createElement("div");
  lbl.className = "bin-label"; lbl.textContent = label;

  const hint   = document.createElement("div");
  hint.className = "bin-hint";

  const pieces = document.createElement("div");
  pieces.className = "bin-pieces";

  bin.appendChild(lbl); bin.appendChild(hint); bin.appendChild(pieces);
  return bin;
}

/* ‚îÄ‚îÄ CREATE PIECE ‚îÄ‚îÄ */
function createPiece(item, binId, idx) {
  const el = document.createElement("div");
  el.className = "piece";
  el.dataset.pid   = item.id;
  el.dataset.binId = binId;
  el.setAttribute("aria-label", item.label);
  el.setAttribute("tabindex",   "0");

  const emoji = document.createElement("div");
  emoji.className    = "piece-emoji";
  emoji.textContent  = item.emoji;

  const lbl = document.createElement("div");
  lbl.className   = "piece-label";
  lbl.textContent = item.label;

  el.appendChild(emoji);
  el.appendChild(lbl);

  const p = { id: item.id, binId, el, placed: false };
  attachDrag(p);
  return p;
}

/* ================================================================
   DRAG & DROP ‚Äî unified mouse + touch
   ================================================================ */
function attachDrag(piece) {
  piece.el.addEventListener("mousedown",  e => startDrag(piece, e.clientX, e.clientY, e));
  piece.el.addEventListener("touchstart", e => {
    const t = e.touches[0];
    startDrag(piece, t.clientX, t.clientY, e);
  }, { passive: false });
}

function startDrag(piece, cx, cy, e) {
  if (G.locked || piece.placed) return;
  e.preventDefault();
  G.dragging = piece;
  piece.el.classList.add("dragging");

  const clone = piece.el.cloneNode(true);
  clone.style.cssText = `width:${piece.el.offsetWidth}px;height:${piece.el.offsetHeight}px;animation:none;opacity:1;`;
  clone.classList.remove("dragging");
  D.ghost.innerHTML = "";
  D.ghost.appendChild(clone);
  D.ghost.style.display = "block";
  moveGhost(cx, cy);

  const onMove = (ex, ey) => { moveGhost(ex, ey); highlightBins(ex, ey); };
  const onEnd  = (ex, ey) => {
    D.ghost.style.display = "none";
    clearHighlights();
    const bin = binUnder(ex, ey);
    if (bin) handleDrop(piece, bin);
    else piece.el.classList.remove("dragging");
    G.dragging = null;
    document.removeEventListener("mousemove", mm);
    document.removeEventListener("mouseup",   mu);
    document.removeEventListener("touchmove", tm);
    document.removeEventListener("touchend",  te);
  };

  const mm = e => onMove(e.clientX, e.clientY);
  const mu = e => onEnd(e.clientX, e.clientY);
  const tm = e => { e.preventDefault(); const t=e.touches[0]; onMove(t.clientX,t.clientY); };
  const te = e => { const t=e.changedTouches[0]; onEnd(t.clientX,t.clientY); };

  document.addEventListener("mousemove", mm);
  document.addEventListener("mouseup",   mu);
  document.addEventListener("touchmove", tm, { passive: false });
  document.addEventListener("touchend",  te);
}

function moveGhost(cx, cy) {
  D.ghost.style.left = cx + "px";
  D.ghost.style.top  = cy + "px";
}
function binUnder(cx, cy) {
  for (const b of document.querySelectorAll(".bin")) {
    const r = b.getBoundingClientRect();
    if (cx>=r.left && cx<=r.right && cy>=r.top && cy<=r.bottom) return b;
  }
  return null;
}
function highlightBins(cx, cy) {
  document.querySelectorAll(".bin").forEach(b => {
    const r = b.getBoundingClientRect();
    b.classList.toggle("drag-over", cx>=r.left && cx<=r.right && cy>=r.top && cy<=r.bottom);
  });
}
function clearHighlights() {
  document.querySelectorAll(".bin").forEach(b => b.classList.remove("drag-over"));
}

/* ================================================================
   DROP LOGIC
   ================================================================ */
function handleDrop(piece, binEl) {
  piece.el.classList.remove("dragging");
  if (binEl.dataset.bid === piece.binId) handleCorrect(piece, binEl);
  else                                    handleError(piece, binEl);
}

function handleCorrect(piece, binEl) {
  piece.placed = true;
  G.correctCount++;
  piece.el.classList.add("placed");
  binEl.querySelector(".bin-pieces").appendChild(piece.el);
  binEl.classList.add("correct-flash");
  setTimeout(() => binEl.classList.remove("correct-flash"), 600);

  beep(880, 90); setTimeout(() => beep(1100, 70), 110);
  launchConfetti(binEl);

  const praises = ["Nice! ‚≠ê","Yes! üéâ","Great! üåü","Correct! ‚ú®","Awesome! ü•≥","Perfect! üíØ"];
  setFeedback("ok", praises[Math.floor(Math.random() * praises.length)]);

  checkLevelComplete();
}

function handleError(piece, binEl) {
  G.errorCount++;
  beep(260, 170);
  binEl.classList.add("error-flash");
  setTimeout(() => binEl.classList.remove("error-flash"), 500);
  setFeedback("no", "Try again! üëÄ");
  speak("Try again.");
}

function checkLevelComplete() {
  if (!G.pieces.every(p => p.placed)) return;
  G.locked = true;

  const star = document.getElementById(`star-${G.level}`);
  if (star) {
    star.classList.add("earned");
    setTimeout(() => { star.classList.add("pop"); setTimeout(() => star.classList.remove("pop"), 550); }, 100);
  }

  setTimeout(() => {
    bigConfetti();
    if (G.level >= TOTAL_LEVELS - 1) setTimeout(showDoneScreen, 900);
    else showReward();
  }, 400);
}

/* ================================================================
   REWARD
   ================================================================ */
const REWARDS = [
  { emoji:"üåü", title:"Superstar!",   sub:"You sorted them all perfectly!" },
  { emoji:"üéâ", title:"Woohoo!",      sub:"Amazing sorting skills!" },
  { emoji:"ü¶Å", title:"So Smart!",    sub:"You're a sorting champion!" },
  { emoji:"üèÜ", title:"Gold Star!",   sub:"Keep up the great work!" },
  { emoji:"üåà", title:"Brilliant!",   sub:"You know your colors and shapes!" },
  { emoji:"üöÄ", title:"Blast Off!",   sub:"On to the next challenge!" },
];

function showReward() {
  const r = REWARDS[G.level % REWARDS.length];
  D.rewardEmoji.textContent = r.emoji;
  D.rewardTitle.textContent = r.title;
  D.rewardSub.textContent   = r.sub;
  D.rewardScreen.classList.add("show");
  beep(660,80); setTimeout(()=>beep(880,80),110); setTimeout(()=>beep(1100,130),240);
}

function advanceLevel() {
  D.rewardScreen.classList.remove("show");
  G.level++;
  if (G.level >= TOTAL_LEVELS) { showDoneScreen(); return; }
  setTimeout(loadLevel, 200);
}

/* ================================================================
   DONE SCREEN
   ================================================================ */
function showDoneScreen() {
  const total = G.correctCount + G.errorCount;
  const acc   = total > 0 ? Math.round((G.correctCount / total) * 100) : 100;
  D.doneScore.textContent = `${acc}% üéØ`;
  D.doneStats.textContent = `${G.correctCount} correct placements`;
  D.doneScreen.classList.add("show");
  D.progressBar.style.width = "100%";
  setTimeout(() => { D.doneAccFill.style.width = acc + "%"; }, 400);
  bigConfetti();
}

function restartGame() {
  G.level = 0; G.correctCount = 0; G.errorCount = 0;
  D.doneScreen.classList.remove("show");
  buildStarRow();
  loadLevel();
}

/* ================================================================
   CONFETTI
   ================================================================ */
const CC = ["#7C3AED","#F59E0B","#10B981","#EF4444","#3B82F6","#EC4899","#FBBF24","#34D399"];
function launchConfetti(anchor) {
  const r = anchor.getBoundingClientRect();
  for (let i = 0; i < 14; i++) {
    const p = document.createElement("div"); p.className = "cp";
    p.style.left = (r.left + r.width/2 + (Math.random()-.5)*70) + "px";
    p.style.top  = r.top + "px";
    p.style.background = CC[i % CC.length];
    p.style.width  = (7 + Math.random()*7) + "px";
    p.style.height = (7 + Math.random()*7) + "px";
    p.style.borderRadius     = Math.random() > .5 ? "50%" : "2px";
    p.style.animationDuration = (0.6 + Math.random()*.5) + "s";
    p.style.animationDelay   = (Math.random()*.15) + "s";
    D.confetti.appendChild(p);
    p.addEventListener("animationend", () => p.remove());
  }
}
function bigConfetti() {
  for (let i = 0; i < 70; i++) {
    const p = document.createElement("div"); p.className = "cp";
    p.style.left = Math.random()*100 + "vw"; p.style.top = "-10px";
    p.style.background = CC[i % CC.length];
    p.style.width  = (8 + Math.random()*10) + "px";
    p.style.height = (8 + Math.random()*10) + "px";
    p.style.borderRadius     = Math.random() > .5 ? "50%" : "3px";
    p.style.animationDuration = (1.2 + Math.random()*1.2) + "s";
    p.style.animationDelay   = (Math.random()*.8) + "s";
    D.confetti.appendChild(p);
    p.addEventListener("animationend", () => p.remove());
  }
}

/* ================================================================
   AUDIO / SPEECH / UTILS
   ================================================================ */
function setFeedback(type, text) {
  D.fbPill.className = "fb-pill";
  D.fbPill.textContent = text || "";
  if (text) { void D.fbPill.offsetWidth; D.fbPill.classList.add("show", type || "ok"); }
}

let _ctx = null;
function getCtx() { if (!_ctx) _ctx = new (window.AudioContext || window.webkitAudioContext)(); return _ctx; }
function beep(freq = 880, ms = 110) {
  try {
    const c = getCtx(), o = c.createOscillator(), g = c.createGain();
    o.type = "sine"; o.frequency.value = freq; g.gain.value = 0.07;
    o.connect(g); g.connect(c.destination); o.start();
    setTimeout(() => { try { o.stop(); } catch(e) {} }, ms);
  } catch(e) {}
}
function speak(text) {
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.92; u.pitch = 1.08;
  window.speechSynthesis.speak(u);
}
function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
