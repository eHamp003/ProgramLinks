<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VB-MAPP Matching ‚Äî Messy Array of 8 (Emoji Cards)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px; background: #fff; border-bottom: 1px solid #e8e8ef;
      position: sticky; top: 0; z-index: 10;
    }
    .title { font-size: 16px; font-weight: 800; }
    .sub { font-size: 12px; opacity: 0.75; }
    .row { display: flex; gap: 12px; padding: 12px 14px; flex-wrap: wrap; }
    .card {
      background: #fff; border: 1px solid #e8e8ef; border-radius: 16px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.04);
    }

    /* Sample area (BIGGER) */
    #sampleWrap { flex: 1 1 360px; min-width: 320px; padding: 14px; }
    .sampleBox {
      display: flex; align-items: center; gap: 14px;
      padding: 14px; border-radius: 14px; border: 2px solid #dfe3ff;
      background: #f3f5ff;
    }
    .sampleEmojiBox{
      width: 150px; height: 150px;
      border-radius: 18px;
      border: 2px solid #eef0ff;
      background: #fff;
      display: grid;
      place-items: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.06);
      flex: 0 0 auto;
    }
    .sampleEmoji{
      font-size: 92px;
      line-height: 1;
    }
    .sampleText { display:flex; flex-direction: column; gap: 6px; }
    .sampleLabel { font-weight: 900; font-size: 18px; }
    .sampleHint { font-size: 13px; opacity: 0.78; }

    /* Playground */
    #playWrap { flex: 2 1 560px; min-width: 340px; padding: 12px; }
    #playArea {
      position: relative;
      height: min(62vh, 560px);
      min-height: 400px;
      border-radius: 16px;
      background: linear-gradient(180deg, #ffffff 0%, #fafbff 100%);
      border: 1px solid #e8e8ef;
      overflow: hidden;
      touch-action: manipulation;
    }

    .choice {
      position: absolute;
      width: 132px; height: 132px;
      border-radius: 18px;
      border: 2px solid #eef0ff;
      background: #fff;
      display: grid;
      place-items: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.06);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transform: translateZ(0);
    }
    .choice:active { transform: scale(0.98); }
    .choiceEmoji{
      font-size: 64px;
      line-height: 1;
      transform: translateY(1px);
    }

    /* Feedback */
    #feedback {
      padding: 0 14px 14px;
      font-size: 14px;
      min-height: 22px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 800;
      border: 1px solid #e8e8ef; background: #fff;
    }
    .ok { border-color:#d7f2d7; background:#f1fff1; }
    .no { border-color:#ffe0e0; background:#fff3f3; }

    /* Prompt highlighting */
    .pulse { animation: pulse 700ms ease-in-out 2; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(90,110,255,0.35); }
      100% { box-shadow: 0 0 0 14px rgba(90,110,255,0); }
    }
    .glow {
      outline: 6px solid rgba(90,110,255,0.45);
      outline-offset: 0px;
      animation: glow 1s ease-in-out 1;
    }
    @keyframes glow {
      0% { outline-color: rgba(90,110,255,0.0); }
      40% { outline-color: rgba(90,110,255,0.55); }
      100% { outline-color: rgba(90,110,255,0.0); }
    }
    .shake { animation: shake 250ms linear 1; }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    /* Confetti */
    .confetti { position:absolute; inset:0; pointer-events:none; }
    .dot {
      position:absolute; width:10px; height:10px; border-radius:50%;
      opacity:0.9;
      animation: fall 650ms ease-out forwards;
    }
    @keyframes fall {
      from { transform: translateY(-10px) scale(1); opacity: 1; }
      to   { transform: translateY(120px) scale(0.7); opacity: 0; }
    }

    /* Supervisor hot corner */
    #hotCorner {
      position: fixed; left: 0; top: 0;
      width: 44px; height: 44px;
      z-index: 1000;
      opacity: 0.0001;
    }

    /* Modal */
    dialog {
      border: none; border-radius: 16px; padding: 0;
      width: min(760px, 94vw);
      box-shadow: 0 24px 70px rgba(0,0,0,0.22);
    }
    .modalHead {
      padding: 12px 14px; background:#fff; border-bottom:1px solid #e8e8ef;
      display:flex; align-items:center; justify-content:space-between;
    }
    .modalBody { padding: 12px 14px; background:#fbfbff; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid label { display:flex; align-items:center; gap: 8px; font-size: 14px; }
    .controls { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      border: 1px solid #e8e8ef; background:#fff; border-radius: 12px;
      padding: 10px 12px; font-weight: 800; cursor: pointer;
    }
    button.primary { background:#5a6eff; border-color:#5a6eff; color:#fff; }
    select { padding: 8px 10px; border-radius: 10px; border:1px solid #e0e0ef; background:#fff; font-weight: 700; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; background:#fff; border-radius:12px; overflow:hidden; }
    th, td { border-bottom: 1px solid #eef0ff; padding: 8px; text-align: left; }
    th { background: #f3f5ff; font-weight: 900; }

    /* Slightly larger tap targets on small screens */
    @media (max-width: 480px){
      .choice { width: 120px; height: 120px; }
      .choiceEmoji { font-size: 58px; }
      .sampleEmojiBox { width: 140px; height: 140px; }
      .sampleEmoji { font-size: 86px; }
    }
  </style>
</head>

<body>
  <div id="hotCorner" title="Supervisor"></div>

  <header>
    <div>
      <div class="title">VB-MAPP Matching</div>
      <div class="sub">Match identical picture in a messy array of 8 (50 targets)</div>
    </div>
    <div class="pill" id="statusPill">Trial <span id="trialNum">1</span>/<span id="trialTotal">10</span></div>
  </header>

  <div class="row">
    <div class="card" id="sampleWrap">
      <div class="sampleBox" id="sampleBox">
        <div class="sampleEmojiBox">
          <div class="sampleEmoji" id="sampleEmoji">üçé</div>
        </div>
        <div class="sampleText">
          <div class="sampleLabel" id="sampleLabel">Match this.</div>
          <div class="sampleHint" id="sampleHint">Tap the one that is exactly the same.</div>
        </div>
      </div>
    </div>

    <div class="card" id="playWrap">
      <div id="playArea"></div>
    </div>
  </div>

  <div id="feedback"></div>

  <dialog id="supervisorDialog">
    <div class="modalHead">
      <div style="font-weight:900;">Supervisor Mode</div>
      <button id="closeSup">Close</button>
    </div>
    <div class="modalBody">
      <div class="grid">
        <label><input type="checkbox" id="optSpeech" checked> Speech (‚ÄúMatch this.‚Äù)</label>
        <label><input type="checkbox" id="optSounds" checked> Sounds</label>
        <label><input type="checkbox" id="optAnim" checked> Animations</label>
        <label><input type="checkbox" id="optPrompts" checked> Prompt hierarchy</label>

        <label>Session length
          <select id="optSession">
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="50">50</option>
          </select>
        </label>

        <label>Reinforce every N correct
          <select id="optReinf">
            <option value="1">1 (continuous)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="5">5</option>
          </select>
        </label>
      </div>

      <div class="controls">
        <button class="primary" id="btnRestart">Restart Session</button>
        <button id="btnExport">Export CSV</button>
        <button id="btnClearData">Clear Data</button>
      </div>

      <div style="margin-top:12px; font-weight:900;">Data (Supervisor only)</div>
      <div style="max-height: 260px; overflow:auto; border-radius:12px; margin-top:8px;">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Time</th><th>Item</th><th>Resp</th><th>Correct</th><th>Prompt</th><th>Latency(ms)</th><th>Errors</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </dialog>

<script>
/* =========================================================
   DATASET: 50 targets (emoji ‚Äúphoto-like‚Äù on iPad)
   Each item has: emoji, label, category, color, shape tags.
   Similar distractors will be chosen by same CATEGORY or COLOR or SHAPE.
   ========================================================= */

const ITEMS = [
  // Food
  {id:"red_apple", emoji:"üçé", label:"apple", category:"food", color:"red", shape:"round"},
  {id:"banana", emoji:"üçå", label:"banana", category:"food", color:"yellow", shape:"long"},
  {id:"orange", emoji:"üçä", label:"orange", category:"food", color:"orange", shape:"round"},
  {id:"strawberry", emoji:"üçì", label:"strawberry", category:"food", color:"red", shape:"triangle"},
  {id:"carrot", emoji:"ü•ï", label:"carrot", category:"food", color:"orange", shape:"triangle"},
  {id:"broccoli", emoji:"ü•¶", label:"broccoli", category:"food", color:"green", shape:"bumpy"},
  {id:"pizza", emoji:"üçï", label:"pizza", category:"food", color:"yellow", shape:"triangle"},
  {id:"burger", emoji:"üçî", label:"burger", category:"food", color:"brown", shape:"round"},
  {id:"cookie", emoji:"üç™", label:"cookie", category:"food", color:"brown", shape:"round"},
  {id:"cupcake", emoji:"üßÅ", label:"cupcake", category:"food", color:"pink", shape:"round"},
  {id:"icecream", emoji:"üç¶", label:"ice cream", category:"food", color:"white", shape:"triangle"},
  {id:"milk", emoji:"ü•õ", label:"milk", category:"food", color:"white", shape:"rect"},
  {id:"juice", emoji:"üßÉ", label:"juice", category:"food", color:"orange", shape:"rect"},
  {id:"water", emoji:"üö∞", label:"water", category:"food", color:"blue", shape:"rect"},
  {id:"lollipop", emoji:"üç≠", label:"lollipop", category:"food", color:"red", shape:"round"},

  // Toys / play
  {id:"teddy", emoji:"üß∏", label:"teddy bear", category:"toy", color:"brown", shape:"round"},
  {id:"toy_car", emoji:"üöó", label:"car", category:"toy", color:"red", shape:"rect"},
  {id:"soccer_ball", emoji:"‚öΩ", label:"soccer ball", category:"toy", color:"white", shape:"round"},
  {id:"block", emoji:"üßä", label:"block", category:"toy", color:"blue", shape:"square"},
  {id:"doll", emoji:"ü™Ü", label:"doll", category:"toy", color:"red", shape:"round"},
  {id:"train", emoji:"üöÇ", label:"train", category:"toy", color:"black", shape:"rect"},
  {id:"dino", emoji:"ü¶ñ", label:"dinosaur", category:"toy", color:"green", shape:"bumpy"},
  {id:"duck", emoji:"ü¶Ü", label:"duck", category:"toy", color:"green", shape:"round"},
  {id:"robot", emoji:"ü§ñ", label:"robot", category:"toy", color:"gray", shape:"rect"},
  {id:"kite", emoji:"ü™Å", label:"kite", category:"toy", color:"red", shape:"diamond"},

  // Household
  {id:"spoon", emoji:"ü•Ñ", label:"spoon", category:"house", color:"gray", shape:"long"},
  {id:"fork", emoji:"üç¥", label:"fork", category:"house", color:"gray", shape:"long"},
  {id:"plate", emoji:"üçΩÔ∏è", label:"plate", category:"house", color:"white", shape:"round"},
  {id:"cup", emoji:"ü•§", label:"cup", category:"house", color:"blue", shape:"rect"},
  {id:"toothbrush", emoji:"ü™•", label:"toothbrush", category:"house", color:"blue", shape:"long"},
  {id:"soap", emoji:"üßº", label:"soap", category:"house", color:"white", shape:"rect"},
  {id:"towel", emoji:"üßª", label:"towel", category:"house", color:"white", shape:"rect"},
  {id:"pillow", emoji:"üõèÔ∏è", label:"bed/pillow", category:"house", color:"blue", shape:"rect"},
  {id:"chair", emoji:"ü™ë", label:"chair", category:"house", color:"brown", shape:"rect"},
  {id:"lamp", emoji:"üí°", label:"lamp", category:"house", color:"yellow", shape:"round"},

  // Clothing
  {id:"shirt", emoji:"üëï", label:"shirt", category:"clothes", color:"blue", shape:"rect"},
  {id:"pants", emoji:"üëñ", label:"pants", category:"clothes", color:"blue", shape:"rect"},
  {id:"shoe", emoji:"üëü", label:"shoe", category:"clothes", color:"gray", shape:"rect"},
  {id:"sock", emoji:"üß¶", label:"sock", category:"clothes", color:"red", shape:"long"},
  {id:"hat", emoji:"üß¢", label:"hat", category:"clothes", color:"blue", shape:"round"},
  {id:"backpack", emoji:"üéí", label:"backpack", category:"clothes", color:"blue", shape:"rect"},
  {id:"coat", emoji:"üß•", label:"coat", category:"clothes", color:"green", shape:"rect"},

  // School
  {id:"pencil", emoji:"‚úèÔ∏è", label:"pencil", category:"school", color:"yellow", shape:"long"},
  {id:"crayon", emoji:"üñçÔ∏è", label:"crayon", category:"school", color:"red", shape:"long"},
  {id:"book", emoji:"üìï", label:"book", category:"school", color:"red", shape:"rect"},
  {id:"scissors", emoji:"‚úÇÔ∏è", label:"scissors", category:"school", color:"gray", shape:"long"},
  {id:"glue", emoji:"üß¥", label:"glue/bottle", category:"school", color:"white", shape:"rect"},
  {id:"ruler", emoji:"üìè", label:"ruler", category:"school", color:"yellow", shape:"long"},
  {id:"clock", emoji:"üïí", label:"clock", category:"school", color:"blue", shape:"round"},
  {id:"laptop", emoji:"üíª", label:"laptop", category:"school", color:"gray", shape:"rect"},
];

/* =========================================================
   Game State & Settings
   ========================================================= */
const state = {
  settings: {
    speech: true,
    sounds: true,
    anim: true,
    prompts: true,
    sessionLen: 10,
    reinfN: 1,
  },
  trialIndex: 0,
  order: [],
  current: null,
  choices: [],
  correctChoiceId: "",
  promptStep: 0, // 0=independent, 1=try again, 2=indirect, 3=positional, 4=model
  errors: 0,
  startMs: 0,
  correctCount: 0,
  data: [],
};

const el = {
  playArea: document.getElementById("playArea"),
  sampleEmoji: document.getElementById("sampleEmoji"),
  sampleBox: document.getElementById("sampleBox"),
  trialNum: document.getElementById("trialNum"),
  trialTotal: document.getElementById("trialTotal"),
  feedback: document.getElementById("feedback"),
  dialog: document.getElementById("supervisorDialog"),
  dataBody: document.querySelector("#dataTable tbody"),
};

/* =========================================================
   Utils
   ========================================================= */
function shuffle(arr) {
  const a = arr.slice();
  for (let i=a.length-1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function setFeedback(type, text) {
  el.feedback.innerHTML = "";
  if (!text) return;
  const span = document.createElement("span");
  span.className = "pill " + (type==="ok" ? "ok" : "no");
  span.textContent = text;
  el.feedback.appendChild(span);
}

function confettiBurst() {
  if (!state.settings.anim) return;
  const layer = document.createElement("div");
  layer.className = "confetti";
  for (let i=0; i<18; i++) {
    const d = document.createElement("div");
    d.className = "dot";
    d.style.left = Math.floor(Math.random()*100) + "%";
    d.style.top = Math.floor(Math.random()*20) + "%";
    d.style.background = ["#5a6eff","#22c55e","#f97316","#ef4444","#a855f7"][i%5];
    d.style.animationDelay = (Math.random()*120) + "ms";
    layer.appendChild(d);
  }
  el.playArea.appendChild(layer);
  setTimeout(()=> layer.remove(), 900);
}

/* =========================================================
   Audio
   ========================================================= */
function beep(freq=880, ms=110) {
  if (!state.settings.sounds) return;
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "sine";
  o.frequency.value = freq;
  g.gain.value = 0.08;
  o.connect(g); g.connect(ctx.destination);
  o.start();
  setTimeout(()=>{ o.stop(); ctx.close(); }, ms);
}

function speak(text) {
  if (!state.settings.speech) return;
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;
  u.pitch = 1.05;
  window.speechSynthesis.speak(u);
}

/* =========================================================
   Similar selection (NO ‚Äúsame exact thing‚Äù)
   Rule: pick 3 from pool that share CATEGORY or COLOR or SHAPE.
   Must NOT be the target, must NOT duplicate.
   ========================================================= */
function getSimilar3(target) {
  // candidates share at least one attribute (category OR color OR shape)
  const candidates = ITEMS.filter(x =>
    x.id !== target.id &&
    (x.category === target.category || x.color === target.color || x.shape === target.shape)
  );

  // We want diversity: ideally mix which attribute matches (category/color/shape)
  // So we score candidates by how many dimensions they share; prefer 1‚Äì2 matches (avoid near-identical)
  const scored = candidates.map(x => {
    let matches = 0;
    if (x.category === target.category) matches++;
    if (x.color === target.color) matches++;
    if (x.shape === target.shape) matches++;
    return { x, matches };
  });

  // Prefer 1‚Äì2 matches, then 3, then 0 (shouldn't happen)
  scored.sort((a,b) => {
    const pa = (a.matches===1||a.matches===2) ? 0 : (a.matches===3 ? 1 : 2);
    const pb = (b.matches===1||b.matches===2) ? 0 : (b.matches===3 ? 1 : 2);
    if (pa !== pb) return pa - pb;
    // slight randomness among equals
    return Math.random() - 0.5;
  });

  const picked = [];
  const used = new Set([target.id]);
  for (const s of scored) {
    if (picked.length >= 3) break;
    const c = s.x;
    if (used.has(c.id)) continue;
    picked.push(c);
    used.add(c.id);
  }

  // Fallback (should rarely happen): fill from remaining non-target items
  if (picked.length < 3) {
    for (const c of shuffle(ITEMS)) {
      if (picked.length >= 3) break;
      if (c.id === target.id) continue;
      if (used.has(c.id)) continue;
      picked.push(c);
      used.add(c.id);
    }
  }

  return picked.slice(0,3);
}

function pickUnrelated4(excludeIds) {
  // unrelated = items that do NOT match category, color, or shape if possible
  const target = state.current;
  const poolStrict = ITEMS.filter(x =>
    !excludeIds.has(x.id) &&
    x.category !== target.category &&
    x.color !== target.color &&
    x.shape !== target.shape
  );
  const poolLoose = ITEMS.filter(x => !excludeIds.has(x.id));

  const pool = poolStrict.length >= 4 ? poolStrict : poolLoose;
  return shuffle(pool).slice(0,4);
}

/* =========================================================
   Trial build: target sample + choices (8)
   Must include EXACT ONE identical match + 3 similar + 4 unrelated
   ========================================================= */
function buildTrial(target) {
  const similar = getSimilar3(target);

  // Exclude set: target + similar
  const exclude = new Set([target.id, ...similar.map(s=>s.id)]);

  const unrelated = pickUnrelated4(exclude);

  // Create 8 choices:
  // - one "correct" card uses the same emoji as target (identical match)
  // - 3 similar items (different emojis)
  // - 4 unrelated items (different emojis)
  const choices = [
    { ...target, choiceId: "correct" },
    ...similar.map((s,i)=>({ ...s, choiceId: "sim"+i })),
    ...unrelated.map((u,i)=>({ ...u, choiceId: "u"+i })),
  ];

  // Safety: ensure no duplicated emojis in the array that could look identical
  // (e.g., some emoji could repeat if dataset has same emoji‚Äîours does not, but this keeps it safe.)
  const seenEmoji = new Set();
  const deduped = [];
  for (const c of choices) {
    const key = c.choiceId === "correct" ? "CORRECT_"+c.emoji : c.emoji;
    if (c.choiceId !== "correct" && seenEmoji.has(key)) continue;
    seenEmoji.add(key);
    deduped.push(c);
  }
  // If dedupe removed something (unlikely), fill with extra unrelated
  while (deduped.length < 8) {
    const filler = shuffle(ITEMS).find(x => x.id !== target.id && !deduped.some(d => d.id === x.id));
    if (!filler) break;
    deduped.push({ ...filler, choiceId: "f"+deduped.length });
  }

  return { sample: target, choices: shuffle(deduped).slice(0,8), correctChoiceId: "correct" };
}

/* =========================================================
   Scatter placement (no overlap)
   ========================================================= */
function placeChoices(choiceEls) {
  const area = el.playArea.getBoundingClientRect();
  const pad = 14;
  const w = 132, h = 132;
  const placed = [];

  function collides(x,y) {
    for (const p of placed) {
      const overlap = !(x+w < p.x || x > p.x+w || y+h < p.y || y > p.y+h);
      if (overlap) return true;
    }
    return false;
  }

  for (const node of choiceEls) {
    let ok = false;
    for (let tries=0; tries<350; tries++) {
      const x = Math.floor(pad + Math.random()*(area.width - w - pad*2));
      const y = Math.floor(pad + Math.random()*(area.height - h - pad*2));
      if (!collides(x,y)) {
        placed.push({x,y});
        node.style.left = x+"px";
        node.style.top  = y+"px";
        ok = true;
        break;
      }
    }
    if (!ok) {
      // Fallback: simple grid-ish placement if too cramped
      const idx = placed.length;
      const cols = Math.max(2, Math.floor((area.wid
